"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _smartobject=_interopRequireDefault(require("@intendant/smartobject")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_cryptoJs=_interopRequireDefault(require("crypto-js")),_package=_interopRequireDefault(require("./package.json"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Plug extends _smartobject.default{constructor(a,b,c){let d=require("./configuration.json");super(a,b,c,d)}async getAccessToken(){let a=this.build(this.settings.client,this.settings.secret,"","GET","?grant_type=1","/v1.0/token?grant_type=1",null),b=await(0,_nodeFetch.default)("https://"+this.settings.domain+"/v1.0/token?grant_type=1",{method:"GET",headers:{t:a.timestamp,sign:a.sign,sign_method:"HMAC-SHA256",nonce:"",stringToSign:"",client_id:this.settings.client}});if(200==b.status){let a=await b.json();return a.success?{error:!1,code:"ok",message:"",access:a.result.access_token}:{error:!0,code:_package.default.name+">getAccessToken>invalidResult",message:"Invalid result "+a.code+" : "+a.msg}}return{error:!0,code:_package.default.name+">getAccessToken>invalidStatus>"+b.status,message:"Invalid status "+b.status}}/*
        Action
    */async __turnOn(a={}){let b=await this.getAccessToken();if(b.error)return b;else{let c=this.build(this.settings.client,this.settings.secret,b.access,"POST","","/v1.0/devices/"+this.settings.id+"/commands",{commands:[{code:a.code,value:!0}]}),d=await(0,_nodeFetch.default)("https://"+this.settings.domain+"/v1.0/devices/"+this.settings.id+"/commands",{method:"POST",headers:{"Content-Type":"application/json",access_token:b.access,t:c.timestamp,sign:c.sign,sign_method:"HMAC-SHA256",nonce:"",stringToSign:"",client_id:this.settings.client},body:JSON.stringify({commands:[{code:a.code,value:!0}]})});if(200==d.status){let a=await d.json();return a.success?{error:!1,code:"ok",message:"",data:a.result}:{error:!0,code:_package.default.name+">turnOn>invalidResult",message:"Invalid result "+a.code+" : "+a.msg}}return{error:!0,code:_package.default.name+">turnOn>invalidStatus>"+d.status,message:"Invalid status "+d.status}}}async __turnOff(a={}){let b=await this.getAccessToken();if(b.error)return b;else{let c=this.build(this.settings.client,this.settings.secret,b.access,"POST","","/v1.0/devices/"+this.settings.id+"/commands",{commands:[{code:a.code,value:!1}]}),d=await(0,_nodeFetch.default)("https://"+this.settings.domain+"/v1.0/devices/"+this.settings.id+"/commands",{method:"POST",headers:{"Content-Type":"application/json",access_token:b.access,t:c.timestamp,sign:c.sign,sign_method:"HMAC-SHA256",nonce:"",stringToSign:"",client_id:this.settings.client},body:JSON.stringify({commands:[{code:a.code,value:!1}]})});if(200==d.status){let a=await d.json();return a.success?{error:!1,code:"ok",message:"",data:a.result}:{error:!0,code:_package.default.name+">turnOff>invalidResult",message:"Invalid result "+a.code+" : "+a.msg}}return{error:!0,code:_package.default.name+">turnOff>invalidStatus>"+d.status,message:"Invalid status "+d.status}}}async __getState(a={}){let b=await this.getAccessToken();if(b.error)return b;else{let a=this.build(this.settings.client,this.settings.secret,b.access,"GET","","/v1.0/devices/"+this.settings.id,null),c=await(0,_nodeFetch.default)("https://"+this.settings.domain+"/v1.0/devices/"+this.settings.id,{method:"GET",headers:{access_token:b.access,t:a.timestamp,sign:a.sign,sign_method:"HMAC-SHA256",nonce:"",stringToSign:"",client_id:this.settings.client}});if(200==c.status){let a=await c.json();return a.success?{error:!1,code:"ok",message:"",data:a.result}:{error:!0,code:_package.default.name+">getState>invalidResult",message:"Invalid result "+a.code+" : "+a.msg}}return{error:!0,code:_package.default.name+">getState>invalidStatus>"+c.status,message:"Invalid status "+c.status}}}build(a,b,c,d,e,f,g){var h=new Date().getTime(),i=_cryptoJs.default.SHA256(null==g?g:JSON.stringify(g)),j=_cryptoJs.default.HmacSHA256(a+c+h+(d+"\n"+i+"\n\n"+f),b),k=j.toString(),l=k.toUpperCase();return{sign:l,timestamp:h,client_id:a,access_token:c}}}var _default=Plug;exports.default=_default,module.exports=exports.default;