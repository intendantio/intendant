"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _expressValidator=require("express-validator"),_Result=_interopRequireDefault(require("../utils/Result")),_package=_interopRequireDefault(require("../package.json")),_fs=_interopRequireDefault(require("fs"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _default=(a,b)=>{a.get("/api/logs",async(a,c)=>{let d=(0,_expressValidator.validationResult)(a);if(d.isEmpty()){a.url="/logs";let d=await b.controller.authentification.checkAuthorization(a);if(d.error)c.send(d);else{let a=[];if(_fs.default.existsSync("./intendant.log")){let b=_fs.default.readFileSync("./intendant.log").toString(),c=b.split("\n");c.pop(),a=c.map(a=>{let b={date:0,type:"UNKNOWN",object:"UNKNOWN",message:"UNKNOWN"};try{b=JSON.parse(a)}catch(a){}return b})}c.send(new _Result.default(_package.default.name,!1,"",a))}}else c.send(new _Result.default(_package.default.name,!0,d.array({onlyFirstError:!0}).pop().msg))}),a.get("/api/configurations",async(a,c)=>{let d=(0,_expressValidator.validationResult)(a);if(d.isEmpty()){a.url="/configurations";let d=await b.controller.user.getStarted();d.error?c.send(d.error):c.send(new _Result.default(_package.default.name,!1,"",{getStarted:d.getStarted,version:_package.default.version,build:_package.default.build}))}else c.send(new _Result.default(_package.default.name,!0,d.array({onlyFirstError:!0}).pop().msg))}),a.post("/api/configurations",(0,_expressValidator.body)("password").isStrongPassword({minLength:8,minLowercase:1,minUppercase:1,minNumbers:1}).withMessage("Invalid password {minLength: 8, minLowercase: 1, minUppercase: 1, minNumbers: 1}"),async(a,c)=>{let d=(0,_expressValidator.validationResult)(a);if(d.isEmpty()){a.url="/configurations";let d=await b.controller.user.getStarted();d.error?c.send(d.error):d.getStarted?c.send(await b.controller.user.insert({login:"admin",password:a.body.password,imei:"",profile:1})):c.send(new _Result.default(_package.default.name,!0,"Invalid core state"))}else c.send(new _Result.default(_package.default.name,!0,d.array({onlyFirstError:!0}).pop().msg))})};exports.default=_default,module.exports=exports.default;