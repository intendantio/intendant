"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _package=_interopRequireDefault(require("../package")),_Controller=_interopRequireDefault(require("./Controller")),_Tracing=_interopRequireDefault(require("../utils/Tracing"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class SmartObject extends _Controller.default{async getAll(){try{let a=[],b=await this.sqlSmartobject.getAll();if(b.error)return b;else{let c=b.data;for(let b=0;b<c.length;b++){let d=c[b],e=await this.getOne(d.id);if(e.error)return e;a.push(e.data)}}return{error:!1,package:_package.default.name,message:"",data:a}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async deleteArguments(a){try{_Tracing.default.verbose(_package.default.name,"Delete smartobject_argument to ["+a+"]");let b=await this.sqlSmartobjectArgument.getOne(a);if(b.error)return b;let c=b.data,d=await this.sqlSmartobjectArgument.deleteAllByField({id:a});if(d.error)return d;let e=await this.core.manager.smartobject.update(c.smartobject);return e.error?e:{error:!1,message:"",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async insertArguments(a,b,c){try{if(_Tracing.default.verbose(_package.default.name,"Insert smartobject_argument to "+a+" ["+b+":"+c+"]"),b){if(c){let d=await this.sqlSmartobject.getOne(a);if(d.error)return d;let e=await this.sqlSmartobjectArgument.insert({id:null,smartobject:a,reference:b,value:c});if(e.error)return e;let f=await this.core.manager.smartobject.update(d.data.id);return f.error?f:{error:!1,message:"",package:_package.default.name}}return _Tracing.default.warning(_package.default.name,"Missing smartobject_argument value"),{error:!0,message:"Missing smartobject_argument value",package:_package.default.name}}return _Tracing.default.warning(_package.default.name,"Missing smartobject_argument reference"),{error:!0,message:"Missing smartobject_argument reference",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async getOne(a){try{let b=await this.sqlSmartobject.getOne(a);if(b.error)return b;if(!1===b.data)return{error:!0,message:"Smartobject not found",package:_package.default.name};let c=b.data,d=await this.sqlSmartobjectArgument.getAllByField({smartobject:c.id});if(d.error)return d;let e=d.data,f=await this.sqlSmartobjectStatus.getOne(c.status);if(f.error)return f;let g=f.data,h=await this.sqlSmartobjectProfile.getAllByField({smartobject:c.id});if(h.error)return h;let i=h.data,j=[],k=null;return this.core.manager.smartobject.smartobjects.has(c.id)&&(j=this.core.manager.smartobject.smartobjects.get(c.id).getActions(),k=this.core.manager.smartobject.smartobjects.get(c.id).moduleConfiguration.icon),{error:!1,data:{id:c.id,icon:k,module:c.module,reference:c.reference,lastUse:c.last_use,status:g,arguments:e,actions:j,profiles:i}}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async insertSmartobjectProfile(a,b){try{let c=await this.sqlSmartobject.getOne(a);if(c.error)return c;let d=c.data,e=await this.sqlSmartobjectProfile.getOneByField({smartobject:a,profile:b});if(e.error)return e;let f=e.data;if(!1===f){let a=await this.sqlSmartobjectProfile.insert({id:null,smartobject:d.id,profile:b});if(a.error)return a}return{error:!1,message:"",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async deleteSmartobjectProfile(a,b){try{let c=await this.sqlSmartobject.getOne(a);if(c.error)return c;let d=c.data,e=await this.sqlSmartobjectProfile.getOneByField({smartobject:a,profile:b});if(e.error)return e;let f=e.data;if(f){let a=await this.sqlSmartobjectProfile.deleteAllByField({id:f.id});if(a.error)return a}return{error:!1,message:"",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async updateLastUse(a){try{let b=await this.sqlSmartobject.updateAll({last_use:"DATE:NOW"},{id:a});return b.error?b:{error:!1,message:"",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async insert(a,b,c){try{if(a){if(!b)return _Tracing.default.warning(_package.default.name,"Missing smartobject reference"),{error:!0,message:"Missing smartobject reference",package:_package.default.name};if(c){let d=await this.sqlSmartobject.getOneByField({reference:b});if(d.error)return d;let e=d.data;if(e)return _Tracing.default.warning(_package.default.name,"Smartobject already exist"),{error:!0,message:"Smartobject already exist",package:_package.default.name};else{let d=await this.sqlSmartobject.insert({id:null,module:a,status:"2",reference:b,last_use:"DATE:NOW"});if(d.error)return d;else{let a=d.data.insertId;for(let b=0;b<c.length;b++){let d=c[b],e=await this.sqlSmartobjectArgument.insert({id:null,smartobject:a,reference:d.reference,value:d.value});if(e.error)return e}return this.core.manager.smartobject.update(a),{error:!1,message:"",package:_package.default.name}}}}else return _Tracing.default.warning(_package.default.name,"Missing smartobject arguments"),{error:!0,message:"Missing smartobject arguments",package:_package.default.name}}else return _Tracing.default.warning(_package.default.name,"Missing smartobject module"),{error:!0,message:"Missing smartobject module",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async delete(a){try{let b=await this.sqlSmartobjectArgument.deleteAllByField({smartobject:a});if(b.error)return b;let c=await this.sqlSmartobject.deleteOne(a);return c.error?c:{error:!1,message:"",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}isAllow(a,b,c=!1){let d=!1;return a.profiles.forEach(a=>{a.profile==b&&(d=!0)}),d||c}async executeAction(a,b,c,d,e=!1){try{if(b){if(c){let f=await this.sqlSmartobject.getOne(a);if(f.error)return f;if(!1==f.data)return{error:!0,message:"Smartobject not found",package:_package.default.name};if(this.core.manager.smartobject.smartobjects.has(f.data.id)){let a=this.core.manager.smartobject.smartobjects.get(f.data.id),g=await this.getOne(a.id);return this.isAllow(g.data,c,e)?a.action(b,d):{error:!0,message:"You are not allowed",package:_package.default.name}}return _Tracing.default.warning(_package.default.name,"Smartobject "+reference+" is missing"),{error:!0,message:"Smartobject "+reference+" is not loaded",package:_package.default.name}}return _Tracing.default.warning(_package.default.name,"Missing smartobject arguments when executeAction"),{error:!0,message:"Missing smartobject arguments",package:_package.default.name}}return _Tracing.default.warning(_package.default.name,"Missing smartobject action when executeAction"),{error:!0,message:"Missing smartobject action",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async getConfiguration(){try{_Tracing.default.verbose(_package.default.name,"Get all modules");let a=[];return this.core.configuration.smartobjects.forEach(b=>{try{let c=require(b+"/package.json");a.push(c)}catch(a){_Tracing.default.warning(_package.default.name,"Impossible get configuration in "+b+" module")}}),{error:!1,package:_package.default.name,message:"",data:a}}catch(a){return _Tracing.default.error(_package.default.name,"SmartObject : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}}var _default=SmartObject;exports.default=_default,module.exports=exports.default;