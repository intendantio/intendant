"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _package=_interopRequireDefault(require("../package")),_Controller=_interopRequireDefault(require("./Controller")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_Result=_interopRequireDefault(require("../utils/Result")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace")),_Parser=_interopRequireDefault(require("../utils/Parser")),_moment=_interopRequireDefault(require("moment")),_fs=_interopRequireDefault(require("fs")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_child_process=require("child_process"),_Utils=_interopRequireDefault(require("../utils/Utils")),_fsExtra=_interopRequireDefault(require("fs-extra"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Smartobject extends _Controller.default{async install(a){try{_fs.default.existsSync("./node_modules/"+a)&&_fsExtra.default.removeSync("./node_modules/"+a),_Tracing.default.verbose(_package.default.name,"Download list from https://market.intendant.io/smartobjects.json");let b=await(0,_nodeFetch.default)("https://market.intendant.io/smartobjects.json",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:0}}),c=await b.json();if(c=c.filter(b=>b.name==a),0==c.length)return _Tracing.default.warning(_package.default.name,"Package not found "+a),new _Result.default(_package.default.name,!0,"Package not found "+a);if(1<c.length)return _Tracing.default.warning(_package.default.name,"Package not found "+a),new _Result.default(_package.default.name,!0,"Package not found "+a);else{let b=c[0],d=await(0,_nodeFetch.default)(b.raw,{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:0}}),e={};try{e=await d.json()}catch(c){return _Tracing.default.warning(_package.default.name,"File not found "+b.raw),new _Result.default(_package.default.name,!0,"Invalid release file "+a)}return _Utils.default.isCompatible(_package.default.version,e.core)?(_Tracing.default.verbose(_package.default.name,"Install "+b.name),await new Promise(a=>{(0,_child_process.exec)("npm install "+e.url+" --silent 2>&1 | tee t",()=>{a()})}),this.smartobjectManager.packages.push(b.name),await this.smartobjectManager.restart(),new _Result.default(_package.default.name,!1,"")):(_Tracing.default.warning(_package.default.name,"Core must have a minimum version of "+e.core+" to accept the module"),new _Result.default(_package.default.name,!0,"Core must have a minimum version of "+e.core+" to accept the module"))}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when install package smartobject"),new _Result.default(_package.default.name,!0,"Error occurred when install package smartobject")}}async getAll(){try{let a=[],b=await this.sqlSmartobject.getAll();if(b.error)return b;else{let c=b.data;for(let b=0;b<c.length;b++){let d=c[b],e=await this.getOne(d.id);if(e.error)return e;a.push(e.data)}}return new _Result.default(_package.default.name,!1,"",a)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all smartobject"),new _Result.default(_package.default.name,!0,"Error occurred when get all smartobject")}}async getOne(a){try{let b=await this.sqlSmartobject.getOne(a);if(b.error)return b;if(!1===b.data)return _Tracing.default.warning(_package.default.name,"Smartobject not found"),new _Result.default(_package.default.name,!0,"Smartobject not found");let c=b.data,d=await this.sqlSmartobjectArgument.getAllByField({smartobject:a});if(d.error)return d;let e=d.data.map(a=>(a.value=_Parser.default.parse(a.value),a)),f=await this.sqlRoom.getOne(c.room);if(f.error)return f;let g=f.data,h=[],i=[],j=[],k=[],l={status:"uninstalled",reason:"Not installed package"},m=!1;if(this.smartobjectManager.instances.has(parseInt(c.id))){m=require(c.module+"/package.json"),h=this.smartobjectManager.instances.get(parseInt(c.id)).getActions(),i=this.smartobjectManager.instances.get(parseInt(c.id)).getWidgets(),j=this.smartobjectManager.instances.get(parseInt(c.id)).getDataSources(),k=this.smartobjectManager.instances.get(parseInt(c.id)).getTriggers();let a=await this.smartobjectManager.instances.get(parseInt(c.id)).getState();if(a.error)return a;l=a.data}return new _Result.default(_package.default.name,!1,"",{id:c.id,module:c.module,reference:c.reference,lastUse:c.last_use,arguments:e,actions:h,widgets:i,dataSources:j,triggers:k,state:l,room:g,configuration:m})}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get one smartobject"),new _Result.default(_package.default.name,!0,"Error occurred when get one smartobject")}}getAllConfiguration(){try{let a=[];for(let b=0;b<this.smartobjectManager.packages.length;b++){let c=this.smartobjectManager.packages[b],d=require(c+"/package.json");a.push(d)}return new _Result.default(_package.default.name,!1,"",a)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all configuration in module"),new _Result.default(_package.default.name,!0,"Error occurred when get all configuration in module")}}async updateLastUse(a){try{let b=await this.sqlSmartobject.updateAll({last_use:(0,_moment.default)().valueOf()},{id:a});return b.error?b:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when update last smartobject use"),new _Result.default(_package.default.name,!0,"Error occurred when update last smartobject use")}}async updateStatus(a,b){try{let c=await this.sqlSmartobject.updateAll({status:b},{id:a});return c.error?c:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when update smartobject status"),new _Result.default(_package.default.name,!0,"Error occurred when update smartobject status")}}async updateRoom(a,b){try{let c=await this.sqlSmartobject.updateAll({room:b},{id:a});return c.error?c:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when update room smartobject"),new _Result.default(_package.default.name,!0,"Error occurred when update room smartobject")}}async updateArgument(a,b,c){try{let d=await this.sqlSmartobjectArgument.updateAll({reference:b,smartobject:a},{value:c});return d.error?d:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when update arguments smartobject"),new _Result.default(_package.default.name,!0,"Error occurred when update arguments smartobject")}}async updateReference(a,b){try{let c=await this.sqlSmartobject.updateAll({reference:b},{id:a});return c.error?c:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when update room smartobject"),new _Result.default(_package.default.name,!0,"Error occurred when update room smartobject")}}async insert(a,b,c,d){try{let e=await this.sqlSmartobject.getOneByField({reference:a});if(e.error)return e;let f=e.data;if(f)return _Tracing.default.warning(_package.default.name,"Smartobject already exist"),new _Result.default(_package.default.name,!0,"Smartobject already exist");else{let e={module:b,status:2,reference:a,last_use:(0,_moment.default)().valueOf(),room:c},f=await this.sqlSmartobject.insert(e);if(f.error)return f;else{let a=f.data.insertId;for(let b=0;b<d.length;b++){let c=d[b],e=await this.sqlSmartobjectArgument.insert({smartobject:a,reference:c.reference,value:_Parser.default.stringify(c.value)});if(e.error)return e}return this.smartobjectManager.update(a),this.getOne(a)}}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when insert smartobject"),new _Result.default(_package.default.name,!0,"Error occurred when insert smartobject")}}async delete(a){try{/* Check process */let b=await this.sqlProcessAction.count({type:"smartobject",object:a});if(b.error)return b;if(0<b.data.count)return new _Result.default(_package.default.name,!0,"Impossible to delete this smartobject that is used in a process");/* Check rapport */let c=await this.sqlRapport.count({type:"smartobject",object:a});if(c.error)return c;if(0<c.data.count)return new _Result.default(_package.default.name,!0,"Impossible to delete this smartobject that is used in a rapport");/* Check widget */let d=await this.sqlWidget.count({type:"smartobject",object:a});if(d.error)return d;if(0<d.data.count)return new _Result.default(_package.default.name,!0,"Impossible to delete this smartobject that is used in a widget");/* Check automation */let e=await this.sqlAutomationTrigger.count({type:"smartobject",object:a});if(e.error)return e;if(0<e.data.count)return new _Result.default(_package.default.name,!0,"Impossible to delete this smartobject that is used in a automation");let f=await this.sqlAutomationAction.count({type:"smartobject",object:a});if(f.error)return f;if(0<f.data.count)return new _Result.default(_package.default.name,!0,"Impossible to delete this smartobject that is used in a automation");let g=await this.sqlSmartobjectArgument.deleteAllByField({smartobject:a});if(g.error)return g;let h=await this.sqlSmartobject.deleteOne(a);return h.error?h:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when delete smartobject"),new _Result.default(_package.default.name,!0,"Error occurred when delete smartobject")}}async executeAction(a,b,c,d){try{if(a=parseInt(a),b){let e=await this.getOne(a);if(e.error)return e;let f=e.data,g=await this.sqlRoomProfile.getOneByField({room:f.room.id,profile:d});if(g.error)return g;if(!1==g.data)return _Tracing.default.warning(_package.default.name,"Not allowed at "+f.room.name),new _Result.default(_package.default.name,!0,"You do not have access to this room ("+f.room.name+")");if(this.smartobjectManager.instances.has(a)){let d=this.smartobjectManager.instances.get(a);this.updateLastUse(a);let e=d.action(b,c);return e.error?e:e}return _Tracing.default.warning(_package.default.name,"Smartobject missing"),new _Result.default(_package.default.name,!0,"Smartobject missing")}return _Tracing.default.warning(_package.default.name,"Missing action"),new _Result.default(_package.default.name,!0,"Missing action")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when execute smartobject action"),new _Result.default(_package.default.name,!0,"Error occurred when execute smartobject action")}}}var _default=Smartobject;exports.default=_default,module.exports=exports.default;