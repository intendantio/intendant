"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Jwt=_interopRequireDefault(require("./tools/Jwt")),_md=_interopRequireDefault(require("md5")),_Controller=_interopRequireDefault(require("./Controller")),_package=_interopRequireDefault(require("../package.json")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_Result=_interopRequireDefault(require("../utils/Result")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace")),_moment=_interopRequireDefault(require("moment")),_scope=_interopRequireDefault(require("../scope.json"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Authentification extends _Controller.default{async getAll(){try{return await this.sqlAuthorization.getAll()}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all authorization"),new _Result.default(_package.default.name,!0,"Error occurred when get all authorization")}}async checkSingleCode(a){let b=await this.sqlSingleCode.getOneByField({code:a});if(b.error)return b;if(!1==b.data)return _Tracing.default.warning(_package.default.name,"Invalid single code authorization"),new _Result.default(_package.default.name,!0,"Invalid single code authorization");let c=request.url.split("/");if("smartobjects"==c[1]&&request.params.idSmartobject){let a=b.data,c=parseInt(request.params.idSmartobject);return parseInt(a.smartobject)==c?new _Result.default(_package.default.name,!1,"",{profile:-1,user:-1}):(_Tracing.default.warning(_package.default.name,"Invalid method to single code"),new _Result.default(_package.default.name,!0,"Invalid method to single code"))}return _Tracing.default.warning(_package.default.name,"Invalid single code authorization"),new _Result.default(_package.default.name,!0,"Invalid single code authorization")}getScope(a,b){return null==_scope.default[b]?(_Tracing.default.warning(_package.default.name,"Invalid method"),new _Result.default(_package.default.name,!0,"Invalid method")):null==_scope.default[b][a]||!1==Array.isArray(_scope.default[b][a])?(_Tracing.default.warning(_package.default.name,"Missing url "+b+":"+a),new _Result.default(_package.default.name,!0,"Invalid url")):new _Result.default(_package.default.name,!1,"",_scope.default[b][a])}async checkAuthorization(a){try{let b=this.getScope(a.url,a.method);if(b.error)return b;let c=b.data;if(c.includes("public"))return new _Result.default(_package.default.name,!1,"");if(a.query.code)return this.checkSingleCode(a.query.code);else{let b=a.headers.authorization;if(null==b)return new _Result.default(_package.default.name,!0,"Missing Bearer token");let d=b.split(" ");if(2!=d.length||"Bearer"!=d[0])return new _Result.default(_package.default.name,!0,"Wrong Bearer token");let e=d[1],f=_Jwt.default.verifyAccessToken(e,this.token);if(f.error)return f;let g=f.data;if((0,_moment.default)().valueOf()>g.exp)return _Tracing.default.warning(_package.default.name,"Expired Bearer token"),new _Result.default(_package.default.name,!0,"Expired Bearer token");let h=await this.sqlUser.getOneByField({login:g.sub});if(h.error)return h;if(!1==h.data)return _Tracing.default.warning(_package.default.name,"Invalid user"),new _Result.default(_package.default.name,!0,"Invalid user");let i=h.data,j=await this.sqlProfile.getOne(i.profile);if(j.error)return j;if(!1==j.data)return _Tracing.default.warning(_package.default.name,"Invalid profile"),new _Result.default(_package.default.name,!0,"Invalid profile");let k=j.data,l=c.includes(k.scope);return!1==l?(_Tracing.default.warning(_package.default.name,a.url+" was not available in "+k.scope+" scope"),new _Result.default(_package.default.name,!0,"Forbidden method")):new _Result.default(_package.default.name,!1,"",{idProfile:k.id})}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when check authorization"),new _Result.default(_package.default.name,!0,"Error occurred when check authorization")}}async getTokenWithRefresh(a){try{let b=await _Jwt.default.verifyAccessToken(a,this.token);if(b.error)return b;let c=await _Jwt.default.verifyAccessToken(b.data.sub,this.token);if(c.error)return c;let d=c.data,e=(0,_moment.default)().add({minutes:30}).valueOf();d.exp=e;let f=await _Jwt.default.generateAccessToken(d,this.token);return f.error?f:new _Result.default(_package.default.name,!1,"",{access_token:f.data,expiry:e})}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get token"),new _Result.default(_package.default.name,!0,"Error occurred when get token")}}async getToken(a,b){try{let c=await this.sqlUser.getOneByField({login:a});if(c.error)return c;let d=c.data;if(d){if((0,_md.default)(b+d.salt)===d.password){let b=(0,_moment.default)().add({minutes:30}).valueOf(),c=JSON.stringify({sub:a,exp:b}),e=_Jwt.default.generateAccessToken(c,this.token);if(e.error)return e;let f=JSON.stringify({sub:e.data}),g=_Jwt.default.generateAccessToken(f,this.token);return g.error?g:new _Result.default(_package.default.name,!1,"",{profile:d.profile,access_token:e.data,refresh_token:g.data,expiry:b})}return _Tracing.default.warning(_package.default.name,"Invalid password"),new _Result.default(_package.default.name,!0,"Invalid password")}return _Tracing.default.warning(_package.default.name,"Invalid login"),new _Result.default(_package.default.name,!0,"Invalid login")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get token"),new _Result.default(_package.default.name,!0,"Error occurred when get token")}}}var _default=Authentification;exports.default=_default,module.exports=exports.default;