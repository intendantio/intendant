"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Jwt=_interopRequireDefault(require("./tools/Jwt")),_md=_interopRequireDefault(require("md5")),_Controller=_interopRequireDefault(require("./Controller")),_package=_interopRequireDefault(require("../package.json")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_Result=_interopRequireDefault(require("../utils/Result")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Authentification extends _Controller.default{constructor(a,b){super(),this.token=a,this.salt=b}async getAll(){try{return await this.sqlAuthorization.getAll()}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all authorization"),new _Result.default(_package.default.name,!0,"Error occurred when get all authorization")}}async getAllAuthorizationByProfile(a){try{let b=await this.sqlAuthorization.getAll();if(b.error)return b;else{let c=await this.sqlAuthorizationProfile.getAllByField({profile:a});if(c.error)return c;else{let a=[];return b.data.forEach(b=>{let d=!1;c.data.forEach(c=>{b.id===c.authorization&&(d=!0,a.push({id:b.id,reference:b.reference,method:b.method,secure:1}))}),!1==d&&a.push({id:b.id,reference:b.reference,method:b.method,secure:0})}),new _Result.default(_package.default.name,!1,"",a)}}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all authorization by profile"),new _Result.default(_package.default.name,!0,"Error occurred when get all authorization by profile")}}async checkAuthorization(a={}){try{let b=a.headers.authorization;b==null&&(b="Bearer aaaa.bbbb.cccc");let c=b.split(" ");if(2!=c.length)return new _Result.default(_package.default.name,!0,"Invalid token");if("Bearer"!=c[0])return new _Result.default(_package.default.name,!0,"Invalid token");let d=c[1],e=await this.sqlAuthorization.getOneByField({reference:a.url,method:a.method});if(e.error)return e;if(!1==e.data){let b=await this.sqlAuthorization.insert({id:null,reference:a.url,method:a.method,secure:"1"});if(b.error)return e;let c=await this.sqlAuthorization.getOneByField({reference:a.url,method:a.method});if(c.error)return c}if(0===e.data.secure)return new _Result.default(_package.default.name,!1,"");let f=_Jwt.default.verifyAccessToken(d,this.token);if(f.valid){let a=f.login.split("~"),b=await this.sqlUser.getOneByField({login:a[1]});if(a[0]!=this.salt)return new _Result.default(_package.default.name,!0,"Invalid token");if(b.error)return b;if(b.data){let a=await this.sqlAuthorizationProfile.getOneByField({profile:b.data.profile,authorization:e.data.id});if(a.error)return a;if(a.data){let a=new _Result.default(_package.default.name,!1,"");return a.profile=b.data.profile,a.user=b.data.id,a}return _Tracing.default.warning(_package.default.name,"Forbidden"),new _Result.default(_package.default.name,!0,"Forbidden")}return _Tracing.default.warning(_package.default.name,"Invalid user"),new _Result.default(_package.default.name,!0,"Invalid user")}return _Tracing.default.warning(_package.default.name,"Invalid token"),new _Result.default(_package.default.name,!0,"Invalid token")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when check authorization"),new _Result.default(_package.default.name,!0,"Error occurred when check authorization")}}async getToken(a,b){try{if(!(a&&""!==a))return _Tracing.default.warning(_package.default.name,"Login is empty"),new _Result.default(_package.default.name,!0,"Login is empty");if(b&&""!==b){let c=await this.sqlUser.getOneByField({login:a});if(c.error)return c;else{let d=c.data;if(d){if((0,_md.default)(b+d.salt)===d.password){let b=new _Result.default(_package.default.name,!1,"");return b.profile=d.profile,b.token=_Jwt.default.generateAccessToken(this.salt+"~"+a,this.token),b}return _Tracing.default.warning(_package.default.name,"Invalid password"),new _Result.default(_package.default.name,!0,"Invalid password")}return _Tracing.default.warning(_package.default.name,"Invalid login"),new _Result.default(_package.default.name,!0,"Invalid login")}}else return _Tracing.default.warning(_package.default.name,"Password is empty"),new _Result.default(_package.default.name,!0,"Password is empty")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get token"),new _Result.default(_package.default.name,!0,"Error occurred when get token")}}async updateAuthorizationByProfile(a,b,c){try{let d=await this.sqlAuthorizationProfile.getOneByField({authorization:b,profile:a});if(d.error)return d;if(0===c){let c=await this.sqlAuthorizationProfile.deleteAllByField({profile:a,authorization:b});return c.error?c:new _Result.default(_package.default.name,!1,"")}if(d.data)return new _Result.default(_package.default.name,!1,"");else{let c=await this.sqlAuthorizationProfile.insert({id:null,authorization:b,profile:a});return c.error?c:new _Result.default(_package.default.name,!1,"")}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when update authorization"),new _Result.default(_package.default.name,!0,"Error occurred when update authorization")}}}var _default=Authentification;exports.default=_default,module.exports=exports.default;