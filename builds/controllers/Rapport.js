"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_Result=_interopRequireDefault(require("../utils/Result")),_package=_interopRequireDefault(require("../package.json"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}const TYPES=["lineChart","pieChart"];class Rapport extends _Controller.default{constructor(a){super(),this.rapportManager=a}async getOne(a){try{let b=await this.sqlRapport.getOne(a);if(b.error)return b;if(!1==b.data)return new _Result.default(_package.default.name,!0,"Missing rapport n\xB0"+a);let c=await this.sqlRapportArgument.getAllByField({rapport:a});return c.error?c:(b.data.settings=c.data,b)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get one rapport"),new _Result.default(_package.default.name,!0,"Error occurred when get one rapport")}}async getAll(){try{let a=await this.sqlRapport.getAll();if(a.error)return a;let b=[];for(let c=0;c<a.data.length;c++){let d=a.data[c],e=await this.sqlRapportArgument.getAllByField({rapport:d.id});if(e.error)return e;d.settings=e.data,b.push(d)}return new _Result.default(_package.default.name,!1,"",b)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all rapport"),new _Result.default(_package.default.name,!0,"Error occurred when get all rapport")}}async insert(a,b,c,d,e,f){try{if(TYPES.includes(b)){if(120>e)return _Tracing.default.warning(_package.default.name,"Interval is too small, minimum 120 seconds"),new _Result.default(_package.default.name,!1,"Interval is too small, minimum 120 seconds");let g=await this.sqlRapport.insert({type:a,chart:b,object:c,reference:d,interval:e});if(g.error)return g;for(let a=0;a<f.length;a++){let b=f[a],c=await this.sqlRapportArgument.insert({reference:b.reference,value:b.value,type:b.type,rapport:g.data.insertId});if(c.error)return c}return this.rapportManager.initialisation(g.data.insertId),await this.getOne(g.data.insertId)}return _Tracing.default.error(_package.default.name,"Invalid rapport type"),new _Result.default(_package.default.name,!1,"Invalid rapport type")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when insert rapport"),new _Result.default(_package.default.name,!0,"Error occurred when insert rapport")}}async delete(a){try{let b=await this.rapportManager.delete(a);if(b.error)return b;let c=await this.truncate(a);if(c.error)return c;let d=await this.sqlRapport.deleteOne(a);return d.error?d:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when delete rapport"),new _Result.default(_package.default.name,!0,"Error occurred when delete rapport")}}async truncate(a){try{let b=await this.sqlRapportData.deleteAllByField({rapport:a});return b.error?b:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when truncate rapport"),new _Result.default(_package.default.name,!0,"Error occurred when truncate rapport")}}async insertData(a,b){try{let c=await this.getOne(a);if(c.error)return c;let d=new Date().getTime(),e="";e="string"==typeof b?b:"object"==typeof b?JSON.stringify(b):"number"==typeof b?b.toString():"boolean"==typeof b?b?"true":"false":"unknown";let f=await this.sqlRapportData.insert({date:d,rapport:a,value:e});return f.error?f:new _Result.default(_package.default.name,!1,"",{})}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when insert data rapport"),new _Result.default(_package.default.name,!0,"Error occurred when insert data rapport")}}async getData(a,b,c){try{let d=await this.getOne(a);if(d.error)return d;let e=await this.sqlRapportData.execute("SELECT * FROM rapport_data WHERE rapport="+a+" AND date >="+b+" AND date <="+c);return e.error?e:(e.data=e.data.map(a=>(delete a.rapport,delete a.id,a)),new _Result.default(_package.default.name,!1,"",e.data))}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get data rapport"),new _Result.default(_package.default.name,!0,"Error occurred when get data rapport")}}}var _default=Rapport;exports.default=_default,module.exports=exports.default;