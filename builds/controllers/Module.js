"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_package=_interopRequireDefault(require("../package.json")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_Result=_interopRequireDefault(require("../utils/Result")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace")),_lodash=_interopRequireDefault(require("lodash")),_md=_interopRequireDefault(require("md5")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_child_process=require("child_process"),_Utils=_interopRequireDefault(require("../utils/Utils"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Module extends _Controller.default{async executeAction(a,b,c){try{if(this.moduleManager.instances.has(a)){let d=this.moduleManager.instances.get(a);return"function"==typeof d["__"+b]?await d["__"+b](c):new _Result.default(_package.default.name,!0,"Action not found")}return new _Result.default(_package.default.name,!0,"Module not found")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when executing an action in module manager"),new _Result.default(_package.default.name,!0,"Error occurred when executing an action in module manager")}}getOne(a){try{let b=require(a+"/package.json");return new _Result.default(_package.default.name,!1,"",b)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all configuration in module"),new _Result.default(_package.default.name,!0,"Error occurred when get all configuration in module")}}getAll(){try{let a=[];for(let b=0;b<this.moduleManager.packages.length;b++){let c=this.moduleManager.packages[b],d=require(c+"/package.json");a.push(d)}return new _Result.default(_package.default.name,!1,"",a)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all configuration in module"),new _Result.default(_package.default.name,!0,"Error occurred when get all configuration in module")}}getByHash(a){let b=!1;return this.moduleManager.packages.forEach(c=>{(0,_md.default)(c)==a&&(b=c)}),new _Result.default(_package.default.name,!1,"",b)}getBySum(a){let b=!1;return this.moduleManager.packages.forEach(c=>{_Utils.default.getSum(c)==a&&(b=c)}),new _Result.default(_package.default.name,!1,"",b)}async install(a){try{_Tracing.default.verbose(_package.default.name,"Download list from https://market.intendant.io/modules.json");let b=await(0,_nodeFetch.default)("https://market.intendant.io/modules.json",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:0}}),c=await b.json();if(c=c.filter(b=>(0,_md.default)(b.name)==a),0==c.length)return _Tracing.default.warning(_package.default.name,"Package not found "+a),new _Result.default(_package.default.name,!0,"Package not found "+a);if(1<c.length)return _Tracing.default.warning(_package.default.name,"Package not found "+a),new _Result.default(_package.default.name,!0,"Package not found "+a);else{let a=c[0],b=await(0,_nodeFetch.default)(a.raw,{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:0}}),d=await b.json();return _Utils.default.isCompatible(_package.default.version,d.core)?(_Tracing.default.verbose(_package.default.name,"Install "+a.name),await new Promise(a=>{(0,_child_process.exec)("npm install "+d.url+" --silent 2>&1 | tee t",()=>{a()})}),this.moduleManager.packages.push(a.name),this.moduleManager.restart(),new _Result.default(_package.default.name,!1,"")):(_Tracing.default.warning(_package.default.name,"Core must have a minimum version of "+d.core+" to accept the module"),new _Result.default(_package.default.name,!0,"Core must have a minimum version of "+d.core+" to accept the module"))}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when install new package"),new _Result.default(_package.default.name,!0,"Error occurred install new package")}}async uninstall(a){try{return _Tracing.default.verbose(_package.default.name,"Uninstall "+a),await new Promise(b=>{(0,_child_process.exec)("npm uninstall "+a+" --silent 2>&1 | tee t",()=>{b()})}),fs.existsSync("./node_modules/"+a)&&fs.rmSync("./node_modules/"+a,{recursive:!0,force:!0}),this.moduleManager.packages=this.moduleManager.packages.filter(b=>a!=b),this.smartobjectManager.packages=this.smartobjectManager.packages.filter(b=>a!=b),this.moduleManager.restart(),await this.smartobjectManager.restart(),new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when uninstall a package"),new _Result.default(_package.default.name,!0,"Error occurred when uninstall a package")}}}var _default=Module;exports.default=_default,module.exports=exports.default;