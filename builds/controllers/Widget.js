"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_package=_interopRequireDefault(require("../package.json")),_lodash=_interopRequireDefault(require("lodash")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace")),_Result=_interopRequireDefault(require("../utils/Result"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Widget extends _Controller.default{constructor(a,b){super(),this.moduleManager=b,this.smartobjectManager=a}extract(a){let b="",c=[],d="",e=0,f=!1;for(let g=0;g<a.length;g++){const h=a[g];"{"===h&&!1===f?f=!0:"}"!==h&&f?d+=h:"}"===h&&f?(f=!1,c.push({key:"{key-"+e+"}",value:d}),b=b+"{key-"+e+"}",e++,d=""):b+=h}return{content:b,extracts:c}}async getOne(a){try{let b=await this.sqlWidget.getOne(a);if(b.error)return b;if(!1==b.data)return new _Result.default(_package.default.name,!0,"Widget not found");let c=b.data,d=await this.sqlWidgetContent.getAllByField({widget:c.id});if(d.error)return d;let e=[],f=d.data;for(let a=0;a<f.length;a++){let b=f[a],c=await this.sqlWidgetContentType.getOne(b.type);if(c.error)return c;b.type=c.data,e.push(b)}f=e;let g=await this.sqlWidgetSource.getAllByField({widget:c.id});if(g.error)return g;let h=[];for(let a=0;a<g.data.length;a++){let b=g.data[a],c=await this.sqlWidgetSourceArgument.getAllByField({widget_source:b.id});if(c.error)return c;b.arguments=c.data,h.push(b)}let i=await this.getSource(h);c.sources=h;let j=[];return c.contents=f.map(a=>{a.native=a.content;let b=this.extract(a.content);if(b.extracts.forEach(c=>{let d="";if("list"==a.type.reference){let d=c.value.split("[x]").length;if(2==d){let d=c.value.split("[x]")[0],e=c.value.split("[x]")[1];0<e.length&&(e=e.substring(1));let f=_lodash.default.get(i.data,d);Array.isArray(f)?(f.forEach(d=>{j.push({id:a.id,widget:1,type:a.type,native:a.native,content:b.content.replace(c.key,""==e?d:_lodash.default.get(d,e))})}),b.content=""):b.content=b.content.replace(c.key,"NotArray")}else 2<d?b.content=b.content.replace(c.key,"MultipleArray"):1==d&&(b.content=b.content.replace(c.key,"UnknownArray"))}else d=i.error?i.package:_lodash.default.get(i.data,c.value),"object"==typeof d?d=JSON.stringify(d):"boolean"==typeof d?d="Boolean":Array.isArray(d)&&(d="Array"),b.content=b.content.replace(c.key,d)}),"list"!=a.type.reference||""!=b.content)return a.content=b.content,a}),c.contents=c.contents.filter(a=>null!=a),j.forEach(a=>{c.contents.push(a)}),new _Result.default(_package.default.name,!1,"",c)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get one widget"),new _Result.default(_package.default.name,!0,"Error occurred when get one widget")}}async getSource(a){try{let b={};for(let c=0;c<a.length;c++){let d=a[c],e={};if(d.arguments.forEach(a=>{e[a.reference]=a.value}),"smartobject"===d.type){let a=await this.sqlSmartobject.getOne(d.object);if(a.error)return a;if(this.smartobjectManager.instances.has(a.data.id)){let c=await this.smartobjectManager.instances.get(a.data.id).action(d.action,e);if(c.error)return c;b[d.reference]=c.data}else return new _Result.default(_package.default.name,!0,"Smartobject not found")}else if("module"===d.type){let a=await this.moduleManager.executeAction(d.object,d.action,e);if(a.error)return a;b[d.reference]=a.data}else return _Tracing.default.error(_package.default.name,"Invalid type"),new _Result.default(_package.default.name,!0,"Invalid type")}return new _Result.default(_package.default.name,!1,"",b)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get source widget"),new _Result.default(_package.default.name,!0,"Error occurred when get source widget")}}async getAll(){try{let a=await this.sqlWidget.getAll();if(a.error)return a;let b=a.data,c=[];for(let a=0;a<b.length;a++){let d=b[a],e=await this.getOne(d.id);if(e.error)return e;c.push(e.data)}return new _Result.default(_package.default.name,!1,"",c)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all widget"),new _Result.default(_package.default.name,!0,"Error occurred when get all widget")}}async insert(a,b,c,d){try{if(a){if(b){if(c){if(d){let e=await this.sqlWidget.insert({reference:a,icon:b});if(e.error)return e;let f=e.data.insertId;for(let a=0;a<c.length;a++){let b=c[a],d=await this.sqlWidgetContent.insert({type:b.type.id,content:b.content,widget:f});if(d.error)return d}for(let a=0;a<d.length;a++){let b=d[a],c=await this.sqlWidgetSource.insert({reference:b.reference,widget:f,object:b.source.id,action:b.action.id,type:b.source.type});if(c.error)return c;let e=c.data.insertId;for(let a=0;a<b.arguments.length;a++){let c=b.arguments[a],d=await this.sqlWidgetSourceArgument.insert({reference:c.reference,value:c.value,widget_source:e});if(d.error)return d}}return new _Result.default(_package.default.name,!1,"")}return _Tracing.default.warning(_package.default.name,"Missing source"),new _Result.default(_package.default.name,!0,"Missing source")}return _Tracing.default.warning(_package.default.name,"Missing content"),new _Result.default(_package.default.name,!0,"Missing content")}return _Tracing.default.warning(_package.default.name,"Missing icon"),new _Result.default(_package.default.name,!0,"Missing icon")}return _Tracing.default.warning(_package.default.name,"Missing reference"),new _Result.default(_package.default.name,!0,"Missing reference")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when insert widget"),new _Result.default(_package.default.name,!0,"Error occurred when insert widget")}}async update(a,b){try{if(b){let c=await this.sqlWidget.getOne(a);if(c.error)return c;let d=await this.sqlWidgetContent.updateAll({content:b.native},{id:b.id});return d.error?d:new _Result.default(_package.default.name,!1,"")}return _Tracing.default.warning(_package.default.name,"Missing content"),new _Result.default(_package.default.name,!1,"Missing content")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when update widget"),new _Result.default(_package.default.name,!0,"Error occurred when update widget")}}async delete(a){try{_Tracing.default.verbose(_package.default.name,"Delete widget "+a);let b=await this.sqlWidgetSource.getAllByField({widget:a});if(b.error)return b;let c=b.data;for(let a=0;a<c.length;a++){let b=c[a],d=await this.sqlWidgetSourceArgument.deleteAllByField({widget_source:b.id});if(d.error)return d}let d=await this.sqlWidgetSource.deleteAllByField({widget:a});if(d.error)return d;let e=await this.sqlWidgetContent.deleteAllByField({widget:a});if(e.error)return e;let f=await this.sqlWidget.deleteOne(a);return f.error?f:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when delete widget"),new _Result.default(_package.default.name,!0,"Error occurred when delete widget")}}async insertSource(a,b,c,d,e){try{if(b){if(c){if(d){if(e){let f=await this.sqlWidget.getOne(a);if(f.error)return f;if(!1==f.data)return new _Result.default(_package.default.name,!0,"Widget not found");let g=await this.sqlWidgetSource.insert({reference:b,widget:a,object:c.id,action:d.id,type:c.type});if(g.error)return g;let h=g.data.insertId;for(let a=0;a<e.length;a++){let b=e[a],c=await this.sqlWidgetSourceArgument.insert({reference:b.reference,value:b.value,widget_source:h});if(c.error)return c}return new _Result.default(_package.default.name,!1,"")}return _Tracing.default.warning(_package.default.name,"Missing arguments"),new _Result.default(_package.default.name,!0,"Missing arguments")}return _Tracing.default.warning(_package.default.name,"Missing action"),new _Result.default(_package.default.name,!0,"Missing action")}return _Tracing.default.warning(_package.default.name,"Missing source"),new _Result.default(_package.default.name,!0,"Missing source")}return _Tracing.default.warning(_package.default.name,"Missing reference"),new _Result.default(_package.default.name,!0,"Missing reference")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when insert source widget"),new _Result.default(_package.default.name,!0,"Error occurred when insert source widget")}}async insertContent(a,b,c){try{if(b){if(c){let d=await this.sqlWidget.getOne(a);if(d.error)return d;if(!1==d.data)return new _Result.default(_package.default.name,!0,"Widget not found");let e=await this.sqlWidgetContent.insert({type:b,content:c,widget:a});return e.error?e:new _Result.default(_package.default.name,!1,"")}return _Tracing.default.warning(_package.default.name,"Missing content"),new _Result.default(_package.default.name,!0,"Missing content")}return _Tracing.default.warning(_package.default.name,"Missing type"),new _Result.default(_package.default.name,!0,"Missing type")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when insert content widget"),new _Result.default(_package.default.name,!0,"Error occurred when insert content widget")}}async deleteSource(a,b){try{let c=await this.sqlWidgetSourceArgument.deleteAllByField({widget_source:b});if(c.error)return c;let d=await this.sqlWidgetSource.deleteAllByField({widget:a,id:b});return d.error?d:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when delete source widget"),new _Result.default(_package.default.name,!0,"Error occurred when delete source widget")}}async deleteContent(a,b){try{let c=await this.sqlWidgetContent.deleteAllByField({widget:a,id:b});return c.error?c:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when delete content widget"),new _Result.default(_package.default.name,!0,"Error occurred when delete content widget")}}async getConfiguration(){try{let a=await this.sqlWidgetContentType.getAll();return a.error?a:new _Result.default(_package.default.name,!1,"",{contents:{types:a.data}})}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get configuration widget"),new _Result.default(_package.default.name,!0,"Error occurred when get configuration widget")}}}var _default=Widget;exports.default=_default,module.exports=exports.default;