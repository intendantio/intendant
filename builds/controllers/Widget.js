"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_package=_interopRequireDefault(require("../package.json")),_lodash=_interopRequireDefault(require("lodash")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace")),_Result=_interopRequireDefault(require("../utils/Result"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Widget extends _Controller.default{constructor(a,b,c,d){super(),this.moduleManager=b,this.moduleController=c,this.smartobjectController=d,this.smartobjectManager=a}async getPackageName(a,b){let c="n/a";if("smartobject"==a){let a=await this.smartobjectController.getOne(b);if(a.error)return a;let d=a.data;if(null!=d.configuration)c=d.configuration.name;else return new _Result.default(_package.default.name,!0,"Missing configuration with smartobject n\xB0"+b)}else c=b;return new _Result.default(_package.default.name,!1,"",c)}async getOne(a){try{let b=await this.sqlWidget.getOne(a);if(b.error)return b;if(!1==b.data)return new _Result.default(_package.default.name,!0,"Widget not found");let c=b.data,d=await this.sqlWidgetArgument.getAllByField({widget:c.id});if(d.error)return d;let e=await this.getPackageName(c.type,c.object);if(e.error)return e;let f=e.data,g=!1,h=this.getWidget(f,c.reference);if(h.error)return h;g=h.data;let i={};c.contents=JSON.parse(JSON.stringify(g.contents)),c.values=JSON.parse(JSON.stringify(g.contents)),c.dataSources={},d.data.forEach(a=>{switch(a.type){case"string":i[a.reference]=a.value;break;case"integer":i[a.reference]=parseInt(a.value);break;case"boolean":i[a.reference]="true"==a.value;}c.values=c.values.map(b=>(b.value=b.value.replace("{settings."+a.reference+"}",i[a.reference]),b))});for(let a=0;a<g.dataSources.length;a++){let b=g.dataSources[a],d=await this.getDataSourceValue(f,b,i,c.object);if(d.error)return d;c.dataSources[b]=d.data.value,c.values=c.values.map(a=>(a.value=a.value.replace("{"+b+"}",d.data.value),a))}if("smartobject"==c.type){let a=await this.smartobjectController.getOne(c.object);if(a.error)return a;c.values=c.values.map(b=>(b.value=b.value.replace("{smartobject.reference}",a.data.reference),b))}return c.values=c.values.map(a=>(a.value=capitalizeFirstLetter(a.value),a)),c.settings=d.data,new _Result.default(_package.default.name,!1,"",c)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get one widget"),new _Result.default(_package.default.name,!0,"Error occurred when get one widget")}}async getAll(){try{let a=await this.sqlWidget.getAll();if(a.error)return a;let b=a.data,c=[];for(let a=0;a<b.length;a++){let d=b[a],e=await this.getOne(d.id);if(e.error)return e;c.push(e.data)}return new _Result.default(_package.default.name,!1,"",c)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all widget"),new _Result.default(_package.default.name,!0,"Error occurred when get all widget")}}async insert(a){try{let b=await this.sqlWidget.insert({type:a.type,object:a.object,reference:a.reference});if(b.error)return b;let c=b.data.insertId;for(let b=0;b<a.settings.length;b++){let d=a.settings[b],e=await this.sqlWidgetArgument.insert({reference:d.reference,value:d.value,type:d.type,widget:c});if(e.error)return e}let d=await this.getOne(c);return d.error&&(await this.delete(c)),d}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when insert widget"),new _Result.default(_package.default.name,!0,"Error occurred when insert widget")}}async delete(a){try{_Tracing.default.verbose(_package.default.name,"Delete widget "+a);let b=await this.sqlWidgetArgument.deleteAllByField({widget:a});if(b.error)return b;let c=await this.sqlWidget.deleteOne(a);return c.error?c:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when delete widget"),new _Result.default(_package.default.name,!0,"Error occurred when delete widget")}}getConfiguration(a){try{let b=require(a+"/package.json");return new _Result.default(_package.default.name,!1,"",b)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get configuration in module"),new _Result.default(_package.default.name,!0,"Error occurred when get configuration in module")}}async getDataSourceValue(a,b,c={},d=-1){try{let e=this.getDataSource(a,b);if(e.error)return e;let f=this.getConfiguration(a);if(f.error)return f;let g=f.data,h=e.data,i=!1;if(g.actions.forEach(a=>{a.id==h.action&&(i=a)}),i){let b=[];if(i.settings.forEach(a=>{null==c[a.id]&&b.push(a)}),0==b.length){let b={error:!0,message:"n/a"};return"module"==g.module?b=await this.moduleController.executeAction(a,i.id,c):"smartobject"==g.module&&(b=await this.smartobjectController.executeAction(d,i.id,1,c,!0)),b.error?b:new _Result.default(_package.default.name,!1,"",{value:_lodash.default.get(b.data,h.path)})}return new _Result.default(_package.default.name,!0,"Missing settings",b)}return _Tracing.default.warning(_package.default.name,"Malformed datasource (missing action)"),new _Result.default(_package.default.name,!0,"Malformed datasource (missing action)")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get data source value in widget"),new _Result.default(_package.default.name,!0,"Error occurred when get data source value in widget")}}getDataSource(a,b){try{let c=this.getConfiguration(a);if(c.error)return c;let d=c.data;if(Array.isArray(d.dataSources)){let a=!1;return d.dataSources.forEach(c=>{c.id==b&&(a=c)}),a?new _Result.default(_package.default.name,!1,"",a):(_Tracing.default.warning(_package.default.name,"Datasource not found"),new _Result.default(_package.default.name,!0,"Datasource not found"))}return _Tracing.default.error(_package.default.name,"Datasources was not implemented"),new _Result.default(_package.default.name,!0,"Datasources was not implemented")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get data source value in module"),new _Result.default(_package.default.name,!0,"Error occurred when get data source value in module")}}getWidget(a,b){try{let c=this.getConfiguration(a);if(c.error)return c;let d=c.data;if(Array.isArray(d.widgets)){let a=!1;return d.widgets.forEach(c=>{c.id==b&&(a=c)}),a?new _Result.default(_package.default.name,!1,"",a):(_Tracing.default.warning(_package.default.name,"Widget not found"),new _Result.default(_package.default.name,!0,"Widget not found"))}return _Tracing.default.error(_package.default.name,"Widgets was not implemented"),new _Result.default(_package.default.name,!0,"Widgets was not implemented")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get widget in module"),new _Result.default(_package.default.name,!0,"Error occurred when get widget in module")}}}function capitalizeFirstLetter(a){return a.charAt(0).toUpperCase()+a.slice(1)}var _default=Widget;exports.default=_default,module.exports=exports.default;