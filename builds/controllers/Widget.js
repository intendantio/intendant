"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_package=_interopRequireDefault(require("../package.json")),_lodash=_interopRequireDefault(require("lodash")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace")),_Result=_interopRequireDefault(require("../utils/Result"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Widget extends _Controller.default{async getPackageName(a,b){let c="";if("smartobject"==a){let a=await this.smartobjectController.getOne(b);if(a.error)return a;let d=a.data;if(null!=d.configuration)c=d.configuration.name;else return new _Result.default(_package.default.name,!0,"Missing configuration with smartobject n\xB0"+b)}else if("module"==a){let a=await this.moduleController.getBySum(b);if(a.error)return a;if(!1==a.data)return new _Result.default(_package.default.name,!0,"Missing configuration with module n\xB0"+b);c=a.data}else return new _Result.default(_package.default.name,!0,"Invalid type");return new _Result.default(_package.default.name,!1,"",c)}async getOne(a){try{let b=await this.sqlWidget.getOne(a);if(b.error)return b;if(!1==b.data)return new _Result.default(_package.default.name,!0,"Widget not found");let c=b.data,d=await this.sqlWidgetArgument.getAllByField({widget:c.id});if(d.error)return d;let e=await this.getPackageName(c.type,c.object);if(e.error)return e;let f=e.data,g=!1,h=this.getWidget(f,c.reference,c.object,c.type);if(h.error)return h;g=h.data;let i={};c.contents=JSON.parse(JSON.stringify(g.contents)),c.values=JSON.parse(JSON.stringify(g.contents)),c.dataSources={},d.data.forEach(a=>{switch(a.type){case"string":i[a.reference]=a.value;break;case"integer":i[a.reference]=parseInt(a.value);break;case"boolean":i[a.reference]="true"==a.value;}c.values=c.values.map(b=>(b.value=b.value.replace("{settings."+a.reference+"}",i[a.reference]),b))});for(let a=0;a<g.dataSources.length;a++){let b=g.dataSources[a],d=await this.getDataSourceValue(f,b,c.type,i,c.object);if(d.error)return d;c.dataSources[b]=d.data.value,c.values=c.values.map(a=>(a.value=a.value.replace("{"+b+"}",d.data.value),a))}if("smartobject"==c.type){let a=await this.smartobjectController.getOne(c.object);if(a.error)return a;c.values=c.values.map(b=>(b.value=b.value.replace("{smartobject.reference}",a.data.reference),b))}return c.values=c.values.map(a=>(a.value=a.value,a)),c.settings=d.data,new _Result.default(_package.default.name,!1,"",c)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get one widget"),new _Result.default(_package.default.name,!0,"Error occurred when get one widget")}}async getAll(){try{let a=await this.sqlWidget.getAll();if(a.error)return a;let b=a.data,c=[];for(let a=0;a<b.length;a++){let d=b[a],e=await this.getOne(d.id);if(e.error)return e;c.push(e.data)}return new _Result.default(_package.default.name,!1,"",c)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all widget"),new _Result.default(_package.default.name,!0,"Error occurred when get all widget")}}async insert(a,b,c,d){try{let e=await this.sqlWidget.insert({type:c,object:b,reference:a});if(e.error)return e;let f=e.data.insertId;for(let a=0;a<d.length;a++){let b=d[a],c=await this.sqlWidgetArgument.insert({reference:b.reference,value:b.value,type:b.type,widget:f});if(c.error)return c}let g=await this.getOne(f);return g.error&&(await this.delete(f)),g}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when insert widget"),new _Result.default(_package.default.name,!0,"Error occurred when insert widget")}}async delete(a){try{let b=await this.sqlWidgetArgument.deleteAllByField({widget:a});if(b.error)return b;let c=await this.sqlWidget.deleteOne(a);return c.error?c:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when delete widget"),new _Result.default(_package.default.name,!0,"Error occurred when delete widget")}}getAllActions(a,b,c){try{let d=this.getInstance(a,b,c);if(d.error)return d;else{let a=d.data.getActions();return null==a&&(a=[]),new _Result.default(_package.default.name,!1,"",a)}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all actions"),new _Result.default(_package.default.name,!0,"Error occurred when get all actions")}}getAllDataSources(a,b,c){try{let d=this.getInstance(a,b,c);if(d.error)return d;else{let a=d.data.getDataSources();return null==a&&(a=[]),new _Result.default(_package.default.name,!1,"",a)}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get data sources"),new _Result.default(_package.default.name,!0,"Error occurred when get data sources")}}getAllWidgets(a,b,c){try{let d=this.getInstance(a,b,c);if(d.error)return d;else{let a=d.data.getWidgets();return null==a&&(a=[]),new _Result.default(_package.default.name,!1,"",a)}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all widgets"),new _Result.default(_package.default.name,!0,"Error occurred when get all widgets")}}getConfiguration(a){try{let b=require(a+"/package.json");return new _Result.default(_package.default.name,!1,"",b)}catch(a){return _Tracing.default.error(_package.default.name,"Error occured when get configuration"),new _Result.default(_package.default.name,!0,"Error occured when get configuration")}}getInstance(a,b,c){try{if("module"==c){let b=this.getConfiguration(a);return b.error?b:new _Result.default(_package.default.name,!1,"",{getActions:()=>b.data.actions,getDataSources:()=>b.data.dataSources,getWidgets:()=>b.data.widgets})}if("smartobject"==c){if(this.smartobjectManager.instances.has(parseInt(b))){let c=this.smartobjectManager.instances.get(parseInt(b));return c.configurations.name==a?new _Result.default(_package.default.name,!1,"",c):(_Tracing.default.error(_package.default.name,"Invalid module type"),new _Result.default(_package.default.name,!0,"Invalid module type"))}return _Tracing.default.error(_package.default.name,"Smartobject not found (gi)"),new _Result.default(_package.default.name,!0,"Smartobject not found (gi)")}return _Tracing.default.error(_package.default.name,"Invalid type"),new _Result.default(_package.default.name,!0,"Invalid type")}catch(a){return _Tracing.default.error(_package.default.name,"Error occured when get instance"),new _Result.default(_package.default.name,!0,"Error occured when get instance")}}async getDataSourceValue(a,b,c,d={},e=-1){try{let f=this.getDataSource(a,b,e,c);if(f.error)return f;let g=this.getAllActions(a,e,c);if(g.error)return g;let h=f.data,i=!1;if(g.data.forEach(a=>{a.id==h.action&&(i=a)}),i){let b=[];if(i.settings.forEach(a=>{null==d[a.id]&&b.push(a)}),0==b.length){let b={error:!0,message:""};return"module"==c?b=await this.moduleController.executeAction(a,i.id,d):"smartobject"==c&&(b=await this.smartobjectController.executeAction(e,i.id,1,d,!0)),b.error?b:new _Result.default(_package.default.name,!1,"",{value:_lodash.default.get(b.data,h.path)})}return new _Result.default(_package.default.name,!0,"Missing settings",b)}return _Tracing.default.warning(_package.default.name,"Malformed datasource (missing action)"),new _Result.default(_package.default.name,!0,"Malformed datasource (missing action)")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get data source value"),new _Result.default(_package.default.name,!0,"Error occurred when get data source value")}}getDataSource(a,b,c,d){try{let e=this.getAllDataSources(a,c,d);if(e.error)return e;if(Array.isArray(e.data)){let a=!1;return e.data.forEach(c=>{c.id==b&&(a=c)}),a?new _Result.default(_package.default.name,!1,"",a):(_Tracing.default.warning(_package.default.name,"Datasource not found"),new _Result.default(_package.default.name,!0,"Datasource not found"))}return _Tracing.default.error(_package.default.name,"Datasources was not implemented"),new _Result.default(_package.default.name,!0,"Datasources was not implemented")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get data source value in module"),new _Result.default(_package.default.name,!0,"Error occurred when get data source value in module")}}getWidget(a,b,c,d){try{let e=this.getAllWidgets(a,c,d);if(e.error)return e;let f=!1;return e.data.forEach(a=>{a.id==b&&(f=a)}),f?new _Result.default(_package.default.name,!1,"",f):(_Tracing.default.warning(_package.default.name,"Widget not found"),new _Result.default(_package.default.name,!0,"Widget not found"))}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get widget in module"),new _Result.default(_package.default.name,!0,"Error occurred when get widget in module")}}}var _default=Widget;exports.default=_default,module.exports=exports.default;