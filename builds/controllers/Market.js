"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_extractZip=_interopRequireDefault(require("extract-zip")),_fs=_interopRequireDefault(require("fs")),_npm=_interopRequireDefault(require("npm")),_package=_interopRequireDefault(require("../package.json")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_child_process=require("child_process");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Market extends _Controller.default{async install(a){try{_Tracing.default.verbose(_package.default.name,"Market controller : download file from https://market.intendant.io");let b=await(0,_nodeFetch.default)("https://market.intendant.io",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:0}}),c=await b.json();if(c=c.filter(b=>b.name==a),0==c.length)return _Tracing.default.warning(_package.default.name,"Market controller : package not found "+a),{package:_package.default.name,message:"",error:!0};if(1<c.length)return _Tracing.default.warning(_package.default.name,"Market controller : package not found "+a),{package:_package.default.name,message:"",error:!0};else{let b=c[0];return _Tracing.default.verbose(_package.default.name,"Market controller : install package "+b.raw),await new Promise(a=>{(0,_child_process.exec)("npm install "+b.raw+" --silent 2>&1 | tee t",()=>{a()})}),_Tracing.default.verbose(_package.default.name,"Market controller : install "+a+" successful"),a.includes("smartobject")?(_Tracing.default.verbose(_package.default.name,"Market controller : restart smartobject manager"),this.core.manager.smartobject.installSmartobjects.push(a),await this.core.manager.smartobject.restart()):a.includes("module")&&(_Tracing.default.verbose(_package.default.name,"Market controller : restart module manager"),this.core.manager.module.installModules.push(a),this.core.manager.module.restart()),{package:_package.default.name,message:"",error:!1}}}catch(a){return _Tracing.default.error("Market : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async uninstall(a){try{return _Tracing.default.verbose(_package.default.name,"Market controller : delete Package "+a),_Tracing.default.verbose(_package.default.name,"Market controller : restart configuration"),await new Promise(b=>{(0,_child_process.exec)("npm uninstall "+a+" --silent 2>&1 | tee t",()=>{b()})}),_fs.default.existsSync("./node_modules/"+a)&&_fs.default.rmSync("./node_modules/"+a,{recursive:!0,force:!0}),this.core.manager.module.installModules=this.core.manager.module.installModules.filter(b=>a!=b),this.core.manager.smartobject.installSmartobjects=this.core.manager.smartobject.installSmartobjects.filter(b=>a!=b),this.core.manager.module.restart(),await this.core.manager.smartobject.restart(),{package:_package.default.name,message:"",error:!1}}catch(a){return _Tracing.default.error("Market : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}}var _default=Market;exports.default=_default,module.exports=exports.default;