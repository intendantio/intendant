"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_fs=_interopRequireDefault(require("fs")),_package=_interopRequireDefault(require("../package.json")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_Result=_interopRequireDefault(require("../utils/Result")),_child_process=require("child_process"),_StackTrace=_interopRequireDefault(require("../utils/StackTrace"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Market extends _Controller.default{constructor(a,b){super(),this.moduleManager=b,this.smartobjectManager=a}async install(a){try{_Tracing.default.verbose(_package.default.name,"Download list from https://market.intendant.io");let b=await(0,_nodeFetch.default)("https://market.intendant.io",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:0}}),c=await b.json();if(c=c.filter(b=>b.name==a),0==c.length)return _Tracing.default.warning(_package.default.name,"Package not found "+a),new _Result.default(_package.default.name,!0,"Package not found "+a);if(1<c.length)return _Tracing.default.warning(_package.default.name,"Package not found "+a),new _Result.default(_package.default.name,!0,"Package not found "+a);else{let b=c[0];return _Tracing.default.verbose(_package.default.name,"Install "+b.name),await new Promise(a=>{(0,_child_process.exec)("npm install "+b.raw+" --silent 2>&1 | tee t",()=>{a()})}),a.includes("smartobject")?(this.smartobjectManager.packages.push(a),await this.smartobjectManager.restart()):a.includes("module")&&(this.moduleManager.packages.push(a),this.moduleManager.restart()),new _Result.default(_package.default.name,!1,"")}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when install new package"),new _Result.default(_package.default.name,!0,"Error occurred install new package")}}async upgrade(a){try{_Tracing.default.verbose(_package.default.name,"Download list from https://market.intendant.io");let b=await(0,_nodeFetch.default)("https://market.intendant.io",{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:0}}),c=await b.json();if(c=c.filter(b=>b.name==a),0==c.length)return _Tracing.default.warning(_package.default.name,"Package not found "+a),new _Result.default(_package.default.name,!0,"Package not found "+a);if(1<c.length)return _Tracing.default.warning(_package.default.name,"Package not found "+a),new _Result.default(_package.default.name,!0,"Package not found "+a);else{let a=c[0];_Tracing.default.verbose(_package.default.name,"Upgrade "+a.name),await new Promise(b=>{(0,_child_process.exec)("npm install "+a.raw+" --silent 2>&1 | tee t",()=>{b()})}),process.exit()}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when install new package"),new _Result.default(_package.default.name,!0,"Error occurred install new package")}}async uninstall(a){try{return _Tracing.default.verbose(_package.default.name,"Uninstall "+a),await new Promise(b=>{(0,_child_process.exec)("npm uninstall "+a+" --silent 2>&1 | tee t",()=>{b()})}),_fs.default.existsSync("./node_modules/"+a)&&_fs.default.rmSync("./node_modules/"+a,{recursive:!0,force:!0}),this.moduleManager.packages=this.moduleManager.packages.filter(b=>a!=b),this.smartobjectManager.packages=this.smartobjectManager.packages.filter(b=>a!=b),this.moduleManager.restart(),await this.smartobjectManager.restart(),new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when uninstall a package"),new _Result.default(_package.default.name,!0,"Error occurred when uninstall a package")}}}var _default=Market;exports.default=_default,module.exports=exports.default;