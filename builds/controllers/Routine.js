"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_package=_interopRequireDefault(require("../package.json")),_Tracing=_interopRequireDefault(require("../utils/Tracing"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Routine extends _Controller.default{async duplicate(a){try{let b=await this.getOne(a),c=b.data,d=await this.insert(c.name+"_duplicate",c.icon,c.watch,c.triggers,c.effects,c.mode);return d}catch(a){return _Tracing.default.error(_package.default.name,"Routine : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async getAll(){try{let a=[],b=await this.sqlRoutine.getAll();if(b.error)return _Tracing.default.warning(_package.default.name,b.message),b;let c=b.data;for(let b=0;b<c.length;b++){let d=c[b],e=await this.getOne(d.id);if(e.error)return e;a.push(e.data)}return{error:!1,message:"",package:_package.default.name,data:a}}catch(a){return _Tracing.default.error(_package.default.name,"Routine : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async getAllEffectByRoutine(a){try{let b=await this.sqlRoutineEffect.getAllByField({routine:a});if(b.error)return b;let c=b.data,d=[];for(let a=0;a<c.length;a++){let b=c[a],e=await this.sqlRoutineEffectArgument.getAllByField({routine_effect:b.id});if(e.error)return e;b.arguments=e.data,d.push(b)}return{error:!1,data:d}}catch(a){return _Tracing.default.error(_package.default.name,"Routine : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async getAllTriggerByRoutine(a){try{let b=await this.sqlRoutineTrigger.getAllByField({routine:a});if(b.error)return b;let c=b.data,d=[];for(let a=0;a<c.length;a++){let b=c[a],e=await this.sqlRoutineTriggerArgument.getAllByField({routine_trigger:b.id});if(e.error)return e;b.arguments=e.data,d.push(b)}return{error:!1,data:d}}catch(a){return _Tracing.default.error(_package.default.name,"Routine : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async getOne(a){try{let b=await this.sqlRoutine.getOne(a);if(b.error)return b;if(!1==b.data)return{error:!0,message:"Routine not found",package:_package.default.name};let c=b.data,d=await this.getAllEffectByRoutine(c.id);if(d.error)return d;let e=d.data,f=await this.getAllTriggerByRoutine(c.id);if(f.error)return f;let g=f.data;return c.triggers=g,c.effects=e,{error:!1,message:"",package:_package.default.name,data:c}}catch(a){return _Tracing.default.error(_package.default.name,"Routine : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async insert(a,b,c,d,e,f){try{if("string"==typeof a&&"string"==typeof f&&"string"==typeof b&&("string"==typeof c||"number"==typeof c)&&Array.isArray(d)&&Array.isArray(e)){let g=await this.sqlRoutine.insert({id:null,name:a,watch:c,icon:b,status:0,mode:f});if(g.error)return g;let h=g.data.insertId;for(let a=0;a<e.length;a++){let b=e[a],c=await this.sqlRoutineEffect.insert({id:null,routine:h,source:b.source,action:b.action,type:b.type});if(c.error)return c;let d=c.data.insertId;for(let a=0;a<b.arguments.length;a++){let c=b.arguments[a],e=await this.sqlRoutineEffectArgument.insert({id:null,routine_effect:d,reference:c.reference,value:c.value});if(e.error)return e}}for(let a=0;a<d.length;a++){let b=d[a],c=await this.sqlRoutineTrigger.insert({id:null,routine:h,source:b.source,action:b.action,type:b.type,result:b.result?b.result:null,statement:b.statement?b.statement:null,expected:b.expected?b.expected:null});if(c.error)return c;let e=c.data.insertId;for(let a=0;a<b.arguments.length;a++){let c=b.arguments[a],d=await this.sqlRoutineTriggerArgument.insert({id:null,routine_trigger:e,reference:c.reference,value:c.value});if(d.error)return d}}}else return{error:!0,message:"Missing parameters",package:_package.default.name};return{error:!1,message:"",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"Routine : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async update(a,b,c,d,e,f,g){try{let h=await this.delete(a);if(h.error)return h;let i=this.insert(b,c,d,e,f,g);return i.error?i:{error:!1,message:"",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"Routine : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async delete(a){try{let b=await this.sqlRoutineEffect.getAllByField({routine:a});if(b.error)return b;for(let a=0;a<b.data.length;a++){let c=b.data[a],d=await this.sqlRoutineEffectArgument.deleteAllByField({routine_effect:c.id});if(d.error)return d}let c=await this.sqlRoutineTrigger.getAllByField({routine:a});if(c.error)return c;for(let a=0;a<c.data.length;a++){let b=c.data[a],d=await this.sqlRoutineTriggerArgument.deleteAllByField({routine_trigger:b.id});if(d.error)return d}return await this.sqlRoutineEffect.deleteAllByField({routine:a}),await this.sqlRoutineTrigger.deleteAllByField({routine:a}),await this.sqlRoutine.deleteOne(a),{error:!1,message:"",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"Routine : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async updateStatus(a,b){try{let c=this.sqlRoutine.updateAll({status:b},{id:a});return c.error?c:(this.core.manager.routine.initialisation(),{error:!1,message:"",package:_package.default.name})}catch(a){return _Tracing.default.error(_package.default.name,"Routine : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}}var _default=Routine;exports.default=_default,module.exports=exports.default;