"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _package=_interopRequireDefault(require("../package")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace")),_Result=_interopRequireDefault(require("../utils/Result")),_md=_interopRequireDefault(require("md5")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_fs=_interopRequireDefault(require("fs"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class ModulesManager{constructor(a){/* Private */this.core=a,this._packages=[],this._instances=new Map,this.before()}async before(){try{_Tracing.default.verbose(_package.default.name,"Start module manager");let a=await(0,_nodeFetch.default)("https://market.intendant.io"),b=await a.json();return b.filter(a=>"module"==a.type&&_fs.default.existsSync("./node_modules/"+a.name)).forEach(a=>{this._packages.push(a.name)}),this.restart()}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when executing before function"),new _Result.default(_package.default.name,!0,"Error occurred when executing before function")}}restart(){try{this._instances=new Map;for(let a=0;a<this._packages.length;a++)try{let b=this._packages[a],c=require(b),d=new c(this.core,_Tracing.default);this._instances.set(b,d),_Tracing.default.verbose(_package.default.name,"Instanciate "+b)}catch(a){_StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when instanciate "+pPackage),this._packages=this._packages.filter(a=>a!=pPackage)}return new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when restart module manager"),new _Result.default(_package.default.name,!0,"Error occurred when restart module manager")}}getAll(){try{let a=[];for(let b=0;b<this._packages.length;b++){let c=this._packages[b],d=require(c+"/package.json");a.push(d)}return new _Result.default(_package.default.name,!1,"",a)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all configuration in module manager"),new _Result.default(_package.default.name,!0,"Error occurred when get all configuration in module manage")}}get packages(){return this._packages}get instances(){return this._instances}set instances(a){return this._instances=a,this.instances}set packages(a){return this._packages=a,this.packages}}var _default=ModulesManager;exports.default=_default,module.exports=exports.default;