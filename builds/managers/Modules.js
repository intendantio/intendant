"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _package=_interopRequireDefault(require("../package")),_md=_interopRequireDefault(require("md5")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_fs=_interopRequireDefault(require("fs"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Modules{constructor(a){this.core=a,this.connector=a.connector,this.logger=a.logger,this.installModules=[],this.modules=new Map,this.before()}async before(){let a=await(0,_nodeFetch.default)("https://market.intendant.io"),b=await a.json();b=b.filter(a=>a.name.includes("-module")),b.forEach(a=>{_fs.default.existsSync("./node_modules/"+a.name)&&this.installModules.push(a.name)}),this.restart()}restart(){try{this.logger.verbose(_package.default.name,"Module manager : restart"),this.modules=new Map,this.installModules.forEach(async a=>{try{let b=require(a),c=new b(this.core);this.modules.set(a,c),this.logger.verbose(_package.default.name,"Module manager : instanciate module "+a+" successful")}catch(b){this.installModules=this.installModules.filter(b=>b!=a)}})}catch(a){return this.core.logger.error("Module manager : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}getByHash(a){let b=!1;return this.installModules.forEach(c=>{(0,_md.default)(c)==a&&(this.logger.verbose(_package.default.name,"Module manager : find hash module "+a+" as "+c),b=c)}),b}async executeAction(a,b,c){try{if(this.modules.has(a)){let d=this.modules.get(a);return"function"==typeof d["__"+b]?await d["__"+b](c):{error:!0,package:_package.default.name,message:"Action not found"}}return{error:!0,package:_package.default.name,message:"Module not found"}}catch(a){return this.core.logger.error("Module manager : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}getAll(){try{let a=[];return this.installModules.forEach(b=>{try{let c=require(b+"/package.json");a.push(c)}catch(a){this.core.logger.error(_package.default.name,"Module manager : inaccessible configuration from module "+b),this.core.logger.error(_package.default.name,JSON.stringify(a.toString()))}}),{error:!1,package:_package.default.name,message:"",data:a}}catch(a){return this.core.logger.error("Module manager : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}}var _default=Modules;exports.default=_default,module.exports=exports.default;