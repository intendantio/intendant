"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _package=_interopRequireDefault(require("../package")),_fs=_interopRequireDefault(require("fs")),_connector=_interopRequireDefault(require("../connector")),_Tracing=_interopRequireDefault(require("../utils/Tracing"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Manager{constructor(a){this.core=a,this.configuration=a.configuration,this.installSmartobjects=[],_Tracing.default.verbose(_package.default.name,"Smartobject manager : start"),this.smartobjects=new Map,this.before()}async before(){try{_Tracing.default.verbose(_package.default.name,"Smartobject manager : disable smartobjects");let a=new _connector.default("smartobject"),b=await a.updateAll({status:2});if(b.error)return void _Tracing.default.warning(_package.default.name,b.package+" "+b.message);await this.initialisation()}catch(a){return _Tracing.default.error(_package.default.name,"Smartobject manager : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async initialisation(){try{let a=new _connector.default("smartobject"),b=await a.getAll();if(b.error)return void _Tracing.default.error(_package.default.name,b.package+" : "+b.message);b.data.forEach(async a=>{await this.instanciate(a)})}catch(a){return _Tracing.default.error(_package.default.name,"Smartobject manager : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async restart(){try{_Tracing.default.verbose(_package.default.name,"Smartobject manager : restart"),this.smartobjects=new Map,await this.before()}catch(a){return _Tracing.default.error(_package.default.name,"Smartobject manager : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async instanciate(a){try{let b=new _connector.default("smartobject"),c=new _connector.default("smartobject_argument");if(!1===this.smartobjects.has(a.id)){let d=await c.getAllByField({smartobject:a.id});if(d.error)return void _Tracing.default.warning(_package.default.name,d.package+" : "+d.message);let e=d.data,f={_id:a.id.toString()};for(let a,b=0;b<e.length;b++)a=e[b],f[a.reference]=a.value;if(this.installSmartobjects.includes(a.module))try{let c=require(a.module),d=new c(this.core,f,_Tracing.default),e=await b.updateAll({status:1},{id:a.id});if(e.error)return void _Tracing.default.warning(_package.default.name,e.message);this.smartobjects.set(a.id,d),_Tracing.default.verbose(_package.default.name,"Smartobject manager : instanciate smartobject n\xB0"+a.id+" successful")}catch(a){_Tracing.default.warning(_package.default.name,a)}else _fs.default.existsSync("./node_modules/"+a.module)?(this.installSmartobjects.push(a.module),this.instanciate(a)):(await b.updateAll({status:3},{id:a.id}),_Tracing.default.warning(_package.default.name,"Smartobject manager : missing smartobject library "+a.module))}}catch(a){return _Tracing.default.error(_package.default.name,"Smartobject manager : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}async update(a){try{_Tracing.default.verbose(_package.default.name,"Smartobject manager : update smartobject n\xB0"+a);let b=new _connector.default("smartobject"),c=await b.getOne(a);if(c.error)return c;let d=c.data;return this.smartobjects.has(d.id)&&this.smartobjects.delete(d.id),await this.instanciate(d),{error:!1,message:"",package:_package.default.name}}catch(a){return _Tracing.default.error(_package.default.name,"Smartobject manager : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}getAll(){try{_Tracing.default.verbose(_package.default.name,"Smartobject manager : get all smartobject configuration");let a=[];return this.installSmartobjects.forEach(b=>{try{let c=require(b+"/package.json");a.push(c)}catch(a){_Tracing.default.warning(_package.default.name,"Smartobject manager : inaccessible configuration from module "+b),_Tracing.default.warning(_package.default.name,a.toString())}}),{error:!1,package:_package.default.name,message:"",data:a}}catch(a){return _Tracing.default.error(_package.default.name,"Smartobject manager : "+a.toString()),{package:_package.default.name,error:!0,message:"Internal server error"}}}}var _default=Manager;exports.default=_default,module.exports=exports.default;