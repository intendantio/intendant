"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _package=_interopRequireDefault(require("../package")),_connector=_interopRequireDefault(require("../connector")),_Tracing=_interopRequireDefault(require("../utils/Tracing")),_StackTrace=_interopRequireDefault(require("../utils/StackTrace")),_fs=_interopRequireDefault(require("fs")),_Result=_interopRequireDefault(require("../utils/Result"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class SmartobjectManager{constructor(a){/* Private */ /* Connector */_Tracing.default.verbose(_package.default.name,"Start smartobject manager"),this.core=a,this._packages=[],this._instances=new Map,this.sqlSmartobject=new _connector.default("smartobject"),this.sqlSmartobjectArgument=new _connector.default("smartobject_argument"),this.before()}async before(){try{let a=await this.sqlSmartobject.updateAll({status:2});if(a.error)return _Tracing.default.warning(_package.default.name,a.package+" "+a.message),a;let b=await this.initialisation();return b.error?b:new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when executing before function"),new _Result.default(_package.default.name,!0,"Error occurred when executing before function")}}async initialisation(){try{let a=await this.sqlSmartobject.getAll();if(a.error)return a;for(let b=0;b<a.data.length;b++){let c=a.data[b],d=await this.instanciate(c);if(d.error)return d}return new _Result.default(_package.default.name,!1,"")}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when initialisation smartobject manager"),new _Result.default(_package.default.name,!0,"Error occurred when initialisation smartobject manager")}}async restart(){try{return this._instances=new Map,await this.before()}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when restart smartobject manager"),new _Result.default(_package.default.name,!0,"Error occurred when restart smartobject manager")}}async instanciate(a){let b=this._instances;try{if(!1===b.has(a.id)){let c=await this.sqlSmartobjectArgument.getAllByField({smartobject:a.id});if(c.error)return _Tracing.default.warning(_package.default.name,c.package+" : "+c.message),c;let d=c.data,e={_id:a.id.toString()};for(let a,b=0;b<d.length;b++)a=d[b],e[a.reference]=a.value;if(this._packages.includes(a.module))try{let c=require(a.module),d=new c(this.core,e,_Tracing.default),f=await this.sqlSmartobject.updateAll({status:1},{id:a.id});if(f.error)return f;b.set(a.id,d),_Tracing.default.verbose(_package.default.name,"Instanciate smartobject n\xB0"+a.id)}catch(a){_Tracing.default.warning(_package.default.name,a)}else if(_fs.default.existsSync("./node_modules/"+a.module)){this._packages.push(a.module);let b=await this.instanciate(a);if(b.error)return b}else{let b=await this.sqlSmartobject.updateAll({status:3},{id:a.id});if(b.error)return b;_Tracing.default.warning(_package.default.name,"Missing package : "+a.module)}}}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when instanciate an smartobject"),new _Result.default(_package.default.name,!0,"Error occurred when instanciate an smartobject")}return this._instances=b,new _Result.default(_package.default.name,!1,"")}async update(a){_Tracing.default.verbose(_package.default.name,"Update smartobject instance n\xB0"+a);try{let b=await this.sqlSmartobject.getOne(a);if(b.error)return b;let c=b.data;this._instances.has(c.id)&&this._instances.delete(c.id);let d=await this.instanciate(c);return d.error?d:new _Result.default(_package.default.name,!1,"")}catch(b){return _Tracing.default.error(_package.default.name,"An error occurred when update smartobject instance n\xB0"+a),_StackTrace.default.save(b),new _Result.default(_package.default.name,!0,"Error occurred when update smartobject")}}getAll(){try{let a=[];for(let b=0;b<this._packages.length;b++){let c=this._packages[b],d=require(c+"/package.json");a.push(d)}return new _Result.default(_package.default.name,!1,"",a)}catch(a){return _StackTrace.default.save(a),_Tracing.default.error(_package.default.name,"Error occurred when get all configuration in smartobject manager"),new _Result.default(_package.default.name,!0,"Error occurred when get all configuration in smartobject manage")}}get packages(){return this._packages}get instances(){return this._instances}set instances(a){return this._instances=a,this.instances}set packages(a){return this._packages=a,this.packages}}var _default=SmartobjectManager;exports.default=_default,module.exports=exports.default;