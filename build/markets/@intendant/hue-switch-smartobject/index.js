"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _smartobject=_interopRequireDefault(require("@intendant/smartobject")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_package=_interopRequireDefault(require("./package.json")),_moment=_interopRequireDefault(require("moment"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class HueSwitch extends _smartobject.default{constructor(a,b,c){let d=require("./configuration.json");super(a,b,c,d),this.events=new Map}/*
        Action
    */async __getState(a={}){let b=await(0,_nodeFetch.default)("http://"+this.settings.path+"/api/"+this.settings.apikey+"/sensors/"+this.settings.id);if(200==b.status){let a=await b.json();if(Array.isArray(a)){let b=0==a.length?"":a[0].error;return this.logger.warning(this.key,"/checkState - error code "+b.type+" return"),{error:!0,code:_package.default.name+">getState>invalidRequest>error",message:"Invalid request "+b}}try{let b=a.state.buttonevent,c=a.state.lastupdated,d=_moment.default.utc(c).format(),e={},f=(0,_moment.default)(new Date().toISOString()).utc(),g=f.diff(d,"seconds");return a.capabilities.inputs.forEach(a=>{a.events.forEach(a=>{a.buttonevent==b&&(e=a)})}),{error:!1,code:"ok",message:"",data:{event:e.buttonevent?e.buttonevent:-1,type:e.eventtype?e.eventtype:"",lastEvent:g}}}catch(a){return{error:!0,code:_package.default.name+">getState>invalidResult",message:"Invalid result"}}}else return{error:!0,code:_package.default.name+">getState>invalidStatus>"+b.status,message:"Invalid status "+b.status}}async __getConfiguration(a={}){let b=await(0,_nodeFetch.default)("http://"+this.settings.path+"/api/"+this.settings.apikey+"/sensors/"+this.settings.id);if(200==b.status){let a=await b.json();if(Array.isArray(a)){let b=0==a.length?"":a[0].error;return this.logger.warning(this.key,"/checkState - error code "+b.type+" return"),{error:!0,code:_package.default.name+">getConfiguration>invalidRequest>error",message:"Invalid request "+b}}return{error:!1,code:"ok",message:"",data:a}}return{error:!0,code:_package.default.name+">getConfiguration>invalidStatus>"+b.status,message:"Invalid status "+b.status}}async __subscribeEvent(a={}){return this.events[a.id]?{error:!0,code:_package.default.name+">subscribeEvent>alreadySubscribe",message:"Event with "+a.id+" is already subscribe"}:(this.events[a.id]={interval:setInterval(async()=>{if(0<this.events[a.id].sleep)return this.events[a.id].sleep=this.events[a.id].sleep-1,void(0==this.events[a.id].sleep&&(this.events[a.id].state=!1));let b=await(0,_nodeFetch.default)("http://"+this.settings.path+"/api/"+this.settings.apikey+"/sensors/"+this.settings.id);if(200==b.status){let c=await b.json();if(Array.isArray(c))return void clearInterval(this.events[a.id].interval);try{if(a.event==c.state.buttonevent){let b=(0,_moment.default)(new Date().toISOString()).utc(),d=b.diff(_moment.default.utc(c.state.lastupdated).format(),"seconds");1>d&&(this.events[a.id].sleep=a.duration,this.events[a.id].state=!0)}}catch(a){return{error:!0,code:_package.default.name+">getState>invalidResult",message:"Invalid result"}}}else return{error:!0,code:_package.default.name+">getState>invalidStatus>"+b.status,message:"Invalid status "+b.status}},1e3),sleep:0,state:!1},{error:!1,code:"ok",message:"",data:[]})}async __readEvent(a={}){return this.events[a.id]?this.events[a.id].state?((!0===a.withUpdate||"true"===a.withUpdate)&&(this.events[a.id].state=!1),{error:!1,code:"ok",message:"",data:{state:!0}}):{error:!1,code:"ok",message:"",data:{state:!1}}:{error:!0,code:_package.default.name+">subscribeEvent>eventNotFound",message:"Event with "+a.id+" not found"}}}var _default=HueSwitch;exports.default=_default,module.exports=exports.default;