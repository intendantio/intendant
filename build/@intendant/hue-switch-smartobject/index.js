"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _smartobject=_interopRequireDefault(require("@intendant/smartobject")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_package=_interopRequireDefault(require("./package.json")),_moment=_interopRequireDefault(require("moment"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class HueSwitch extends _smartobject.default{constructor(a,b,c){super(a,b,c,_package.default)}/*
        Action
    */async request(){let a=await(0,_nodeFetch.default)("http://"+this.settings.path+"/api/"+this.settings.apikey+"/sensors/"+this.settings.id);if(200==a.status){let b=await a.json();return Array.isArray(b)?(this.core.logger.warning(_package.default.name,"Invalid request"),{error:!0,package:_package.default.name,message:"Invalid request"}):{error:!1,package:_package.default.name,message:"",data:b}}return this.core.logger.warning(_package.default.name,"Invalid status"),{error:!0,package:_package.default.name,message:"Invalid status"}}async __event(a={}){let b=await this.request();if(b.error)return b;try{let a=b.data.state.buttonevent,c=b.data.state.lastupdated,d=_moment.default.utc(c).format(),e={},f=(0,_moment.default)(new Date().toISOString()).utc(),g=f.diff(d,"seconds");return b.data.capabilities.inputs.forEach(b=>{b.events.forEach(b=>{b.buttonevent==a&&(e=b)})}),{error:!1,package:_package.default.name,message:"",data:{event:e.buttonevent?e.buttonevent:-1,type:e.eventtype?e.eventtype:"",lastEvent:g}}}catch(a){return this.core.logger.warning(_package.default.name,a.toString()),{error:!0,package:_package.default.name,message:"Invalid result"}}}async __configuration(a={}){return this.request()}async __state(a={}){if(null==a.event)return this.core.logger.warning(_package.default.name,"Event is missing"),{error:!0,package:_package.default.name,message:"Event is missing"};if(null==a.type)return this.core.logger.warning(_package.default.name,"Type is missing"),{error:!0,package:_package.default.name,message:"Type is missing"};if(null==a.duration)return this.core.logger.warning(_package.default.name,"Duration is missing"),{error:!0,package:_package.default.name,message:"Duration is missing"};let b=await this.__event({});if(b.error)return b;let c=b.data;return a.type==c.type?c.event.toString()[0]==a.event?parseInt(a.duration)>c.lastEvent?{error:!1,package:_package.default.name,data:{reason:"",state:!0}}:{error:!1,package:_package.default.name,data:{reason:"duration too long",state:!1}}:{error:!1,package:_package.default.name,data:{reason:"event invalid",state:!1}}:{error:!1,package:_package.default.name,data:{reason:"type invalid",state:!1}}}}var _default=HueSwitch;exports.default=_default,module.exports=exports.default;