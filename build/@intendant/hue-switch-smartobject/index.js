"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _smartobject=_interopRequireDefault(require("@intendant/smartobject")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_package=_interopRequireDefault(require("./package.json")),_https=_interopRequireDefault(require("https")),_moment=_interopRequireDefault(require("moment"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}const httpsAgent=new _https.default.Agent({rejectUnauthorized:!1});class HueSwitch extends _smartobject.default{constructor(a,b,c){super(a,b,c,_package.default),this.currentState={button:{last_event:""}},setTimeout(()=>{this.initialisation()},5e3)}initialisation(){if(this.logger.verbose(_package.default.name,"Initialisation"),this.core.manager.smartobject.smartobjects.has(parseInt(this.settings.hueBridge))){let a=this.core.manager.smartobject.smartobjects.get(parseInt(this.settings.hueBridge));a.listener[this.settings.id]=a=>{this.logger.verbose(_package.default.name,"Update state smartobject "+this.settings.id),this.currentState=a}}}getHueSettings(){return this.core.manager.smartobject.smartobjects.has(parseInt(this.settings.hueBridge))?{error:!1,package:_package.default.name,data:this.core.manager.smartobject.smartobjects.get(parseInt(this.settings.hueBridge)).settings,message:""}:{error:!0,package:_package.default.name,message:"Missing smartobject instance "+this.settings.hueBridge}}/*
        Action
    */async __configuration(a={}){let b=this.getHueSettings();if(b.error)return b;let c=await(0,_nodeFetch.default)("https://"+b.data.path+"/clip/v2/resource/button/"+this.settings.id,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","hue-application-key":b.data.apikey},agent:httpsAgent});if(200==c.status){let a=await c.json();return 0<a.errors.length?{error:!0,package:_package.default.name,message:"Invalid request "+JSON.stringify(a.errors)}:{error:!1,package:_package.default.name,message:"",data:a.data[0]}}return{error:!0,package:_package.default.name,message:"Invalid status "+c.status}}async __state(a={}){if({long_release:"long",short_release:"short"}[this.currentState.button.last_event]==a.type){let b=_moment.default.utc(this.currentState.creationtime).format(),c=(0,_moment.default)(new Date().toISOString()).utc(),d=c.diff(b,"seconds");return d<a.duration?{error:!1,package:_package.default.name,data:{reason:"",state:!0}}:{error:!1,package:_package.default.name,data:{reason:"duration too long",state:!1}}}return{error:!1,package:_package.default.name,data:{reason:"type invalid",state:!1}}}}var _default=HueSwitch;exports.default=_default,module.exports=exports.default;