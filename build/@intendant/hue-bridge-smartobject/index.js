"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _smartobject=_interopRequireDefault(require("@intendant/smartobject")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_package=_interopRequireDefault(require("./package.json")),_https=_interopRequireDefault(require("https")),_color=_interopRequireDefault(require("./lib/color"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}const httpsAgent=new _https.default.Agent({rejectUnauthorized:!1});class Hub extends _smartobject.default{constructor(a,b,c){super(a,b,c,_package.default),this.updateState(),this.listener={}}async updateState(){this.core.logger.verbose(_package.default.name,"Long polling");let a=await(0,_nodeFetch.default)("https://"+this.settings.path+"/eventstream/clip/v2",{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","hue-application-key":this.settings.apikey},agent:httpsAgent});if(200==a.status){let b=await a.json(),c=b[0];c.data.forEach(a=>{"function"==typeof this.listener[a.id]&&(a.creationtime=c.creationtime,this.listener[a.id](a))})}setTimeout(()=>{this.updateState()},500)}/*
        Action
    */async __turnOn(a={}){let b=a.color?_color.default.isHexColor(a.color.slice(1,1/0))?a.color:"#ffffff":"#ffffff",c=_color.default.hexToLab(b);a.duration==null&&(a.duration=200),a.brightness==null&&(a.brightness=70);let d={on:{on:!0},dimming:{brightness:parseInt(a.brightness)},color:{xy:{x:c.x,y:c.y}},dynamics:{duration:parseInt(a.duration)}},e=await(0,_nodeFetch.default)("https://"+this.settings.path+"/clip/v2/resource/light/"+this.settings.id,{method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json","hue-application-key":this.settings.apikey},agent:httpsAgent,body:JSON.stringify(d)});if(200==e.status){let a=await e.json();return 0<a.errors.length?{error:!0,package:_package.default.name,message:"Invalid request "+JSON.stringify(a.errors)}:{error:!1,package:_package.default.name,message:"",data:a.data[0]}}return{error:!0,package:_package.default.name,message:"Invalid status "+e.status}}async __turnOff(a={}){a.duration==null&&(a.duration=200);let b={on:{on:!1},dynamics:{duration:parseInt(a.duration)}},c=await(0,_nodeFetch.default)("https://"+this.settings.path+"/clip/v2/resource/light/"+this.settings.id,{method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json","hue-application-key":this.settings.apikey},agent:httpsAgent,body:JSON.stringify(b)});if(200==c.status){let a=await c.json();return 0<a.errors.length?{error:!0,package:_package.default.name,message:"Invalid request "+JSON.stringify(a.errors)}:{error:!1,package:_package.default.name,message:"",data:a.data[0]}}return{error:!0,package:_package.default.name,message:"Invalid status "+c.status}}async __state(a={}){let b=await(0,_nodeFetch.default)("https://"+this.settings.path+"/clip/v2/resource/light/"+this.settings.id,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json","hue-application-key":this.settings.apikey},agent:httpsAgent});if(200==b.status){let a=await b.json();return 0<a.errors.length?{error:!0,package:_package.default.name,message:"Invalid request "+JSON.stringify(a.errors)}:{error:!1,package:_package.default.name,message:"",data:a.data[0]}}return{error:!0,package:_package.default.name,message:"Invalid status "+b.status}}}var _default=Hub;exports.default=_default,module.exports=exports.default;