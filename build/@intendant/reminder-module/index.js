"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _package=_interopRequireDefault(require("./package.json")),_nodeSchedule=_interopRequireDefault(require("node-schedule"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Reminder{constructor(a){this.core=a,this.instances=new Map,this.prepare()}async prepare(){let a=await this.core.controller.storage.getItem(_package.default.name);a.error?(this.core.logger.warning(_package.default.name,a.message),await this.clear()):Array.isArray(a.data)?a.data.forEach(a=>{this.instanciate(a)}):await this.clear()}async deleteOne(a){let b=await this.core.controller.storage.getItem(_package.default.name);b.data=b.data.filter(b=>b.reference!=a),await this.core.controller.storage.setItem(_package.default.name,b.data)}async clear(){this.instances=new Map,await this.core.controller.storage.setItem(_package.default.name,[])}instanciate(a){return this.instances.has(a.reference)?(this.core.logger.warning(_package.default.name,"Already instanciate job "+a.reference),{error:!0,package:_package.default.name,message:"Already instanciate job "+a.reference}):(this.core.logger.verbose(_package.default.name,"Instanciate "+a.reference),this["job-"+a.reference]=_nodeSchedule.default.scheduleJob(a.cron,async()=>{this.core.logger.verbose(_package.default.name,"Execution job "+a.reference),!1==a.repeating&&(await this.__removeOne(a));let b=await this.core.controller.client.getAll();await this.core.controller.notification.notify("Intendant",a.information,b.data.map(a=>a.token))}),null==this["job-"+a.reference]?(this.core.logger.warning(_package.default.name,"Invalid Cron value "+a.cron),this.deleteOne(a.reference),{error:!0,package:_package.default.name,message:"Invalid cron value "+a.cron}):(this.instances.set(a.reference,!0),{error:!1,package:_package.default.name,message:""}))}async __create(a={}){try{if("string"==typeof a.reference&&"string"==typeof a.information&&"string"==typeof a.cron){a.repeating=!!a.repeating&&a.repeating;let b=await this.core.controller.storage.getItem(_package.default.name);return b.error?b:this.instances.has(a.reference)?(this.core.logger.warning(_package.default.name,"Already exist job "+data.reference),{error:!0,package:_package.default.name,message:"Already exist job "+data.reference}):(b.data.push(a),await this.core.controller.storage.setItem(_package.default.name,b.data),this.instanciate(a))}return this.core.logger.warning(_package.default.name,"Missing parameters"),{error:!0,package:_package.default.name,message:"Missing parameters"}}catch(a){return this.core.logger.warning(_package.default.name,a.toString()),{error:!0,package:_package.default.name,message:"Throw exception"}}}async __getOne(a={}){let b=await this.core.controller.storage.getItem(_package.default.name);if(b.error)return b;let c=b.data,d=!1;return c.forEach(b=>{b.reference==a.reference&&(d=b)}),!1==d?{package:_package.default.name,message:"Reminder "+a.reference+" not found",error:!0}:{package:_package.default.name,message:"",error:!1,data:d}}async __getAll(a={}){return await this.core.controller.storage.getItem(_package.default.name)}async __removeOne(a={}){try{return this.instances.has(a.reference)?("object"==typeof this["job-"+a.reference]&&this["job-"+a.reference].cancel(),this.deleteOne(a.reference),this.instances.delete(a.reference),this.core.logger.verbose(_package.default.name,"Remove job "+a.reference),{error:!1,package:_package.default.name,message:""}):{error:!0,package:_package.default.name,message:"Reminder not found"}}catch(a){let b=_package.default.name+" "+JSON.stringify(a.toString());return this.core.logger.error(_package.default.name,b),{error:!0,package:_package.default.name,message:"Internal error server : "+JSON.stringify(a.toString())}}}}var _default=Reminder;exports.default=_default,module.exports=exports.default;