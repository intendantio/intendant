"use strict";var _package=_interopRequireDefault(require("../package"));Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Manager{constructor(a){this.core=a,this.connector=a.connector,this.logger=a.logger,this.configuration=a.configuration,this.installSmartobjects=[],this.logger.verbose(_package.default.name,"Smartobject manager : start"),this.smartobjects=new Map,this.before()}async before(){this.logger.verbose(_package.default.name,"Smartobject manager : disable smartobjects");let a=new this.connector(this.configuration,this.core,"smartobject"),b=await a.updateAll({status:2});return b.error?void this.logger.warning(_package.default.name,b.package+" "+b.message):void(await this.initialisation())}async initialisation(){let a=new this.connector(this.configuration,this.core,"smartobject"),b=await a.getAll();return b.error?void this.logger.error(_package.default.name,b.package+" : "+b.message):void b.data.forEach(async a=>{await this.instanciate(a)})}async restart(){this.core.logger.verbose(_package.default.name,"Smartobject manager : restart"),this.smartobjects=new Map,await this.before()}async instanciate(a){let b=new this.connector(this.configuration,this.core,"smartobject"),c=new this.connector(this.configuration,this.core,"smartobject_argument");if(!1===this.smartobjects.has(a.reference)){let d=await c.getAllByField({smartobject:a.id});if(d.error)return void this.logger.warning(_package.default.name,d.package+" : "+d.message);let e=d.data,f={_id:a.id.toString()};for(let a,b=0;b<e.length;b++)a=e[b],f[a.reference]=a.value;if(this.installSmartobjects.includes(a.module))try{let c=require(a.module),d=require(a.module+"/Package.json"),e=new c(f,this.core,d),g=await b.updateAll({status:1},{id:a.id});if(g.error)return void this.logger.warning(_package.default.name,g.message);this.smartobjects.set(a.reference,e),this.logger.verbose(_package.default.name,"Smartobject manager : instanciate smartobject n\xB0"+a.id+" successful")}catch(a){this.logger.warning(_package.default.name,a)}else await b.updateAll({status:3},{id:a.id}),this.logger.warning(_package.default.name,"Smartobject manager : missing smartobject library "+a.module)}}async update(a){this.core.logger.verbose(_package.default.name,"Smartobject manager : update smartobject n\xB0"+a);let b=new this.connector(this.configuration,this.core,"smartobject"),c=await b.getOne(a);if(c.error)return c;let d=c.data;return this.smartobjects.has(d.reference)&&this.smartobjects.delete(d.reference),await this.instanciate(d),{error:!1,message:"",package:_package.default.name}}getAll(){this.core.logger.verbose(_package.default.name,"Smartobject manager : get all smartobject configuration");let a=[];return this.installSmartobjects.forEach(b=>{try{let c=require(b+"/Package.json");a.push(c)}catch(a){this.core.logger.warning(_package.default.name,"Smartobject manager : inaccessible configuration from module "+b),this.core.logger.warning(_package.default.name,JSON.stringify(a.toString()))}}),{error:!1,package:_package.default.name,message:"",data:a}}}var _default=Manager;exports.default=_default,module.exports=exports.default;