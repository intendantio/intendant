"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_nodeFetch=_interopRequireDefault(require("node-fetch")),_extractZip=_interopRequireDefault(require("extract-zip")),_fs=_interopRequireDefault(require("fs")),_npm=_interopRequireDefault(require("npm")),_package=_interopRequireDefault(require("../package.json"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Market extends _Controller.default{async install(a){let b=await(0,_nodeFetch.default)("https://market.intendant.io"),c=await b.json();if(c=c.filter(b=>b.package==a),0==c.length)return this.core.logger.warning(_package.default.name,"Package not found"),{package:_package.default.name,message:"",error:!0};if(1<c.length)return this.core.logger.warning(_package.default.name,"Package not found"),{package:_package.default.name,message:"",error:!0};else{this.core.logger.verbose(_package.default.name,"Find package "+a);let b=c[0];this.core.logger.verbose(_package.default.name,"Start download package "+a);let d=await(0,_nodeFetch.default)(b.raw);const e=await d.buffer();_fs.default.mkdirSync(require("path").resolve("./")+"/.intendant/"+a,{recursive:!0}),_fs.default.writeFileSync(require("path").resolve("./")+"/.tmp-download.zip",e),this.core.logger.verbose(_package.default.name,"Extract package "+a),await(0,_extractZip.default)(require("path").resolve("./")+"/.tmp-download.zip",{dir:require("path").resolve("./")+"/.intendant/"+a}),this.core.logger.verbose(_package.default.name,"Remove tmp file"),_fs.default.unlinkSync(require("path").resolve("./")+"/.tmp-download.zip");let f=JSON.parse(_fs.default.readFileSync(require("path").resolve("./")+"/package.json").toString()),g=JSON.parse(_fs.default.readFileSync(require("path").resolve("./")+"/.intendant/"+a+"/package.json").toString());for(let a in g.dependencies){let b=g.dependencies[a],c=!1;for(let b in f.dependencies){let d=f.dependencies[b];a==b&&(c=d)}c||(this.core.logger.verbose(_package.default.name,"Add dependencie "+a+":"+b),f.dependencies[a]=b)}return _fs.default.writeFileSync(require("path").resolve("./")+"/package.json",JSON.stringify(f),null,4),await new Promise(a=>{_npm.default.load(()=>{a()})}),await new Promise(a=>{_npm.default.commands.install([],()=>{a()})}),this.core.logger.verbose(_package.default.name,"Restart configuration"),this.core.prepare(),this.core.manager.module.restart(),await this.core.manager.smartobject.restart(),{package:_package.default.name,message:"",error:!1}}}async uninstall(a){return this.core.logger.verbose(_package.default.name,"Delete Package "+a),_fs.default.rmdirSync(require("path").resolve("./")+"/.intendant/"+a,{recursive:!0}),this.core.logger.verbose(_package.default.name,"Restart configuration"),this.core.prepare(),this.core.manager.module.restart(),await this.core.manager.smartobject.restart(),{package:_package.default.name,message:"",error:!1}}}var _default=Market;exports.default=_default,module.exports=exports.default;