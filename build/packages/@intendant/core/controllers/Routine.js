"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _Controller=_interopRequireDefault(require("./Controller")),_package=_interopRequireDefault(require("../package.json"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Routine extends _Controller.default{async duplicate(a){let b=await this.getOne(a),c=b.data,d=await this.insert(c.name+"_duplicate",c.icon,c.watch,c.triggers,c.effects);return d}async getAll(){let a=[];console.log(this);let b=await this.sqlRoutine.getAll();if(b.error)return this.core.logger.warning(_package.default.name,b.message),b;let c=b.data;for(let b=0;b<c.length;b++){let d=c[b],e=await this.getOne(d.id);if(e.error)return e;a.push(e.data)}return{error:!1,message:"",code:"ok",data:a}}async getAllEffectByRoutine(a){let b=await this.sqlRoutineEffect.getAllByField({routine:a});if(b.error)return b;let c=b.data,d=[];for(let b=0;b<c.length;b++){let a=c[b],e=await this.sqlRoutineEffectArgument.getAllByField({routine_effect:a.id});if(e.error)return e;a.arguments=e.data,d.push(a)}return{error:!1,data:d}}async getAllTriggerByRoutine(a){let b=await this.sqlRoutineTrigger.getAllByField({routine:a});if(b.error)return b;let c=b.data,d=[];for(let b=0;b<c.length;b++){let a=c[b],e=await this.sqlRoutineTriggerArgument.getAllByField({routine_trigger:a.id});if(e.error)return e;a.arguments=e.data,d.push(a)}return{error:!1,data:d}}async getOne(a){let b=await this.sqlRoutine.getOne(a);if(b.error)return b;if(!1==b.data)return{error:!0,message:"Routine not found",code:_package.default.name+">Routine>NotFound"};let c=b.data,d=await this.getAllEffectByRoutine(c.id);if(d.error)return d;let e=d.data,f=await this.getAllTriggerByRoutine(c.id);if(f.error)return f;let g=f.data;return c.triggers=g,c.effects=e,{error:!1,message:"",code:"ok",data:c}}async insert(a,b,c,d,e){if("string"==typeof a&&"string"==typeof b&&"number"==typeof c&&Array.isArray(d)&&Array.isArray(e)){let f=await this.sqlRoutine.insert({id:null,name:a,watch:c,icon:b,status:0});if(f.error)return f;let g=f.data.insertId;for(let a=0;a<e.length;a++){let b=e[a],c=await this.sqlRoutineEffect.insert({id:null,routine:g,source:b.source,action:b.action,type:b.type});if(c.error)return c;let d=c.data.insertId;for(let a=0;a<b.arguments.length;a++){let c=b.arguments[a],e=await this.sqlRoutineEffectArgument.insert({id:null,routine_effect:d,reference:c.reference,value:c.value});if(e.error)return e}}for(let a=0;a<d.length;a++){let b=d[a],c=await this.sqlRoutineTrigger.insert({id:null,routine:g,source:b.source,action:b.action,type:b.type,result:b.result?b.result:null,statement:b.statement?b.statement:null,expected:b.expected?b.expected:null});if(c.error)return c;let e=c.data.insertId;for(let a=0;a<b.arguments.length;a++){let c=b.arguments[a],d=await this.sqlRoutineTriggerArgument.insert({id:null,routine_trigger:e,reference:c.reference,value:c.value});if(d.error)return d}}}else return{error:!0,message:"Missing parameters",code:_package.default.name+">insert>missingParameters"};return{error:!1,message:"",code:"ok"}}async update(a,b,c,d,e,f){let g=await this.delete(a);if(g.error)return g;let h=this.insert(b,c,d,e,f);return h.error?h:{error:!1,message:"",code:"ok"}}async delete(a){let b=await this.sqlRoutineEffect.getAllByField({routine:a});if(b.error)return b;for(let c=0;c<b.data.length;c++){let a=b.data[c],d=await this.sqlRoutineEffectArgument.deleteAllByField({routine_effect:a.id});if(d.error)return d}let c=await this.sqlRoutineTrigger.getAllByField({routine:a});if(c.error)return c;for(let b=0;b<c.data.length;b++){let a=c.data[b],d=await this.sqlRoutineTriggerArgument.deleteAllByField({routine_trigger:a.id});if(d.error)return d}return await this.sqlRoutineEffect.deleteAllByField({routine:a}),await this.sqlRoutineTrigger.deleteAllByField({routine:a}),await this.sqlRoutine.deleteOne(a),{error:!1,message:"",code:"ok"}}async updateStatus(a,b){let c=this.sqlRoutine.execute("UPDATE `routine` SET `status`='"+b+"' WHERE id="+a);return c.error?c:{error:!1,message:"",code:"ok"}}getConfiguration(){let a=[],b=[];return this.core.configuration.routines.triggers.forEach(b=>{let c=require(b+"/configuration.json");a.push(c)}),this.core.configuration.routines.effects.forEach(a=>{let c=require(a+"/configuration.json");b.push(c)}),{error:!1,message:"",code:"ok",data:{triggers:a,effects:b}}}}var _default=Routine;exports.default=_default,module.exports=exports.default;