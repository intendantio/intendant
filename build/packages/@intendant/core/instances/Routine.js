"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _package=_interopRequireDefault(require("../package.json")),ToadScheduler=_interopRequireWildcard(require("toad-scheduler")),_nodeSchedule=_interopRequireDefault(require("node-schedule")),_lodash=_interopRequireDefault(require("lodash"));function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(a,b){if(!b&&a&&a.__esModule)return a;if(null===a||"object"!=typeof a&&"function"!=typeof a)return{default:a};var c=_getRequireWildcardCache(b);if(c&&c.has(a))return c.get(a);var d={},e=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in a)if("default"!=f&&Object.prototype.hasOwnProperty.call(a,f)){var g=e?Object.getOwnPropertyDescriptor(a,f):null;g&&(g.get||g.set)?Object.defineProperty(d,f,g):d[f]=a[f]}return d.default=a,c&&c.set(a,d),d}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Routine{constructor(a,b){if(this.scheduler=new ToadScheduler.ToadScheduler,this.core=b,this.configuration=b.configuration,this.logger=b.logger,this.id=a.id,this.name=a.name,this.triggers=a.triggers,this.effects=a.effects,this.watch=a.watch,this.mode=a.mode,this.sqlRoutine=new this.core.connector(this.configuration,this.core,"routine"),"counter"==this.mode){let a=new ToadScheduler.Task(this.id,async()=>{let a=!0;for(let b,c=0;c<this.triggers.length;c++)switch(b=this.triggers[c],b.type){case"smartobject":let d=new this.core.connector(this.configuration,this.core,"smartobject"),e=await d.getOne(b.source);if(e.error)return this.logger.warning(_package.default.name,e.package+" "+e.error),await this.sqlRoutine.updateAll({status:0},{id:this.id}),void this.close();let f=e.data,g={};b.arguments.map(a=>{g[a.reference]=a.value});let h=await this.core.controller.smartobject.executeAction(f.id,b.action,-1,g,!0);if(h.error)return this.logger.warning(_package.default.name,h.package+" "+h.error),void this.close();if(null!=b.result){let c=h.data,d=this.test(_lodash.default.get(c,b.result),b.statement,b.expected);!1==d&&(a=!1)}break;case"module":let i={};effect.arguments.map(a=>{i[a.reference]=a.value});let j=await this.core.manager.module.executeAction(effect.source,effect.action,i);if(j.error)return this.logger.warning(_package.default.name,j.package+" "+j.error),void this.close();if(null!=b.result){let c=j.data,d=this.test(_lodash.default.get(c,b.result),b.statement,b.expected);!1==d&&(a=!1)}break;case"process":let k=new this.core.connector(this.configuration,this.core,"process"),l=await k.getOne(b.source);if(l.error)return this.logger.warning(_package.default.name,l.package+" "+l.error),await this.sqlRoutine.updateAll({status:0},{id:this.id}),void this.close();let m={};b.arguments.map(a=>{m[a.reference]=a.value});let n=await this.core.controller.process.executeAction(b.source,-1,m,!0);if(n.error)return this.logger.warning(_package.default.name,n.package+" "+n.error),void this.close();if(null!=b.result){let c=n.data,d=this.test(_lodash.default.get(c,b.result),b.statement,b.expected);!1==d&&(a=!1)}break;default:this.logger.warning(_package.default.name,"Type not found"),this.close();}if(a)for(let a,b=0;b<this.effects.length;b++)switch(a=this.effects[b],a.type){case"smartobject":let c=new this.core.connector(this.configuration,this.core,"smartobject"),d=await c.getOne(a.source);if(d.error)return this.logger.warning(_package.default.name,d.package+" "+d.error),void this.close();let e=d.data,f={};a.arguments.map(a=>{f[a.reference]=a.value});let g=await this.core.controller.smartobject.executeAction(e.id,a.action,-1,f,!0);if(g.error)return this.logger.warning(_package.default.name,g.package+" "+g.error),void this.close();break;case"module":let h={};a.arguments.map(a=>{h[a.reference]=a.value});let i=await this.core.manager.module.executeAction(a.source,a.action,h);if(i.error)return this.logger.warning(_package.default.name,i.package+" "+i.error),void this.close();break;case"process":let j=new this.core.connector(this.configuration,this.core,"process"),k=await j.getOne(a.source);if(k.error)return this.logger.warning(_package.default.name,k.package+" "+k.error),await this.sqlRoutine.updateAll({status:0},{id:this.id}),void this.close();let l={};a.arguments.map(a=>{l[a.reference]=a.value});let m=await this.core.controller.process.executeAction(a.source,-1,l,!0);if(m.error)return this.logger.warning(_package.default.name,m.package+" "+m.error),void this.close();break;default:this.logger.warning(_package.default.name,"Type not found"),this.close();}});this.scheduler.addSimpleIntervalJob(new ToadScheduler.SimpleIntervalJob({seconds:parseInt(this.watch)},a))}else"week"==this.mode&&_nodeSchedule.default.scheduleJob(this.watch,async()=>{let a=!0;for(let b,c=0;c<this.triggers.length;c++)switch(b=this.triggers[c],b.type){case"smartobject":let d=new this.core.connector(this.configuration,this.core,"smartobject"),e=await d.getOne(b.source);if(e.error)return this.logger.warning(_package.default.name,e.package+" "+e.error),await this.sqlRoutine.updateAll({status:0},{id:this.id}),void this.close();let f=e.data,g={};b.arguments.map(a=>{g[a.reference]=a.value});let h=await this.core.controller.smartobject.executeAction(f.id,b.action,-1,g,!0);if(h.error)return this.logger.warning(_package.default.name,h.package+" "+h.error),void this.close();if(null!=b.result){let c=h.data,d=this.test(_lodash.default.get(c,b.result),b.statement,b.expected);!1==d&&(a=!1)}break;case"module":let i={};effect.arguments.map(a=>{i[a.reference]=a.value});let j=await this.core.manager.module.executeAction(effect.source,effect.action,i);if(j.error)return this.logger.warning(_package.default.name,j.package+" "+j.error),void this.close();if(null!=b.result){let c=j.data,d=this.test(_lodash.default.get(c,b.result),b.statement,b.expected);!1==d&&(a=!1)}break;case"process":let k=new this.core.connector(this.configuration,this.core,"process"),l=await k.getOne(b.source);if(l.error)return this.logger.warning(_package.default.name,l.package+" "+l.error),await this.sqlRoutine.updateAll({status:0},{id:this.id}),void this.close();let m={};b.arguments.map(a=>{m[a.reference]=a.value});let n=await this.core.controller.process.executeAction(b.source,-1,m,!0);if(n.error)return this.logger.warning(_package.default.name,n.package+" "+n.error),void this.close();if(null!=b.result){let c=n.data,d=this.test(_lodash.default.get(c,b.result),b.statement,b.expected);!1==d&&(a=!1)}break;default:this.logger.warning(_package.default.name,"Type not found"),this.close();}if(a)for(let a,b=0;b<this.effects.length;b++)switch(a=this.effects[b],a.type){case"smartobject":let c=new this.core.connector(this.configuration,this.core,"smartobject"),d=await c.getOne(a.source);if(d.error)return this.logger.warning(_package.default.name,d.package+" "+d.error),void this.close();let e=d.data,f={};a.arguments.map(a=>{f[a.reference]=a.value});let g=await this.core.controller.smartobject.executeAction(e.id,a.action,-1,f,!0);if(g.error)return this.logger.warning(_package.default.name,g.package+" "+g.error),void this.close();break;case"module":let h={};a.arguments.map(a=>{h[a.reference]=a.value});let i=await this.core.manager.module.executeAction(a.source,a.action,h);if(i.error)return this.logger.warning(_package.default.name,i.package+" "+i.error),void this.close();break;case"process":let j=new this.core.connector(this.configuration,this.core,"process"),k=await j.getOne(a.source);if(k.error)return this.logger.warning(_package.default.name,k.package+" "+k.error),await this.sqlRoutine.updateAll({status:0},{id:this.id}),void this.close();let l={};a.arguments.map(a=>{l[a.reference]=a.value});let m=await this.core.controller.process.executeAction(a.source,-1,l,!0);if(m.error)return this.logger.warning(_package.default.name,m.package+" "+m.error),void this.close();break;default:this.logger.warning(_package.default.name,"Type not found"),this.close();}console.log("Execute")})}test(a,b,c){return null==a||null==a?a="":"number"==typeof a?c=parseInt(c):a=a.toString(),"equal"===b?a==c:"bigger"===b?a>c:"smaller"===b?a<c:"different"==b&&a!=c}async close(){await this.sqlRoutine.updateAll({status:0},{id:this.id}),this.scheduler.stop()}}var _default=Routine;exports.default=_default,module.exports=exports.default;
