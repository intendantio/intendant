"use strict";var _package=_interopRequireDefault(require("../package"));Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Manager{constructor(a){this.core=a,this.connector=a.connector,this.logger=a.logger,this.configuration=a.configuration,this.logger.verbose(_package.default.name,"Start Manager"),this.smartobjects=new Map,this.before()}async before(){let a=new this.connector(this.configuration,this.core,"smartobject"),b=await a.updateAll({status:2});return b.error?void this.logger.warning(_package.default.name,b.code+" "+b.message):void(await this.initialisation())}async initialisation(){let a=new this.connector(this.configuration,this.core,"smartobject"),b=await a.getAll();return b.error?void this.logger.error(_package.default.name,b.code+" : "+b.message):void b.data.forEach(async a=>{await this.instanciate(a)})}async restart(){this.core.logger.verbose(_package.default.name,"Restart Smartobject Manager"),await this.initialisation()}async instanciate(a){let b=new this.connector(this.configuration,this.core,"smartobject"),c=new this.connector(this.configuration,this.core,"smartobject_argument");if(!1===this.smartobjects.has(a.reference)){let d=await c.getAllByField({smartobject:a.id});if(d.error)return void this.logger.warning(_package.default.name,d.code+" : "+d.message);let e=d.data,f={_id:a.id.toString()};for(let a,b=0;b<e.length;b++)a=e[b],f[a.reference]=a.value;if(this.configuration.smartobjects.includes(a.module))try{let c=require(require("path").resolve("./")+"/.intendant/"+a.module+"/index.js"),d=require(require("path").resolve("./")+"/.intendant/"+a.module+"/configuration.json"),e=new c(f,this.core,d),g=await b.updateAll({status:1},{id:a.id});if(g.error)return void this.logger.warning(_package.default.name,g.message);this.smartobjects.set(a.reference,e)}catch(a){this.logger.warning(_package.default.name,a)}else await b.updateAll({status:3},{id:a.id}),this.logger.warning(_package.default.name,"Package "+a.module+" has not installed")}}async update(a){this.core.logger.verbose(_package.default.name,"Update smartobject "+a);let b=new this.connector(this.configuration,this.core,"smartobject"),c=await b.getOne(a);if(c.error)return c;let d=c.data;return this.smartobjects.has(d.reference)&&this.smartobjects.delete(d.reference),await this.instanciate(d),{error:!1,message:"",code:"ok"}}getAll(){this.core.logger.verbose(_package.default.name,"Get all smartobject");let a=[];return this.configuration.smartobjects.forEach(b=>{try{let c=require(require("path").resolve("./")+"/.intendant/"+b+"/configuration.json");a.push(c)}catch(a){this.core.logger.warning(_package.default.name,"Impossible get configuration in "+b+" module"),this.core.logger.warning(_package.default.name,JSON.stringify(a.toString()))}}),{error:!1,code:"ok",message:"",data:a}}}var _default=Manager;exports.default=_default,module.exports=exports.default;